<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Coder idiosyncrasy]]></title>
  <link href="http://miguelcamba.com/atom.xml" rel="self"/>
  <link href="http://miguelcamba.com/"/>
  <updated>2017-04-12T09:28:50+01:00</updated>
  <id>http://miguelcamba.com/</id>
  <author>
    <name><![CDATA[Miguel Camba]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[The Future of Ember's Testing and the Beheading of jQuery]]></title>
    <link href="http://miguelcamba.com/blog/2017/04/11/the-future-of-embers-testing-and-the-beheading-of-jquery/"/>
    <updated>2017-04-11T23:35:53+01:00</updated>
    <id>http://miguelcamba.com/blog/2017/04/11/the-future-of-embers-testing-and-the-beheading-of-jquery</id>
    <content type="html"><![CDATA[<p>For those writing Ember apps, jQuery has been an omnipresent shadow from the beginning.
It is included by default with the framework and seems to be infiltrated everywhere in it
and in the community. Well, that is about to end.</p>

<!-- more -->


<p>In reality Ember bundled jQuery with it as one of its &ldquo;opinions&rdquo; but the framework
itself it not SO dependent on jQuery. There is basically only three features in Ember
that rely in it:</p>

<ul>
<li><code>this.$()</code></li>
<li>The event dispatcher (The thing that makes actions work and methods named after events like <code>click() {}</code> in you components
be called)</li>
<li>Testing. Pretty much everything.</li>
</ul>


<p>But a lot of things have changed since Ember decided that bundling jQuery was a good idea back in 2011.
Then jQuery was the thing we all were building things on, mobile web apps were anecdotical at
best and IE 7/8 was so popular that few people dared to code stuff for them without the
cross-browser safety net of some library.</p>

<p>Today we build apps that run mostly for evergreen browsers and perhaps IE11, mobile
accounts for a good 50% of our visits if not more, and making a network request is no longer
something that requires you to copy-paste some obscure code from stackoverflow, so it&rsquo;s time
to make jQuery one of those Ember opinions you can disagree with.</p>

<p>Before you start following this post, consider if it&rsquo;s worth the effort for you to do this.</p>

<p><strong>If you have an app that is months or years old, it will take significant effort remove jQuery</strong>.
It will require refactor ALL your tests, stop using jQuery it in all the places where you did (and I bet
you did in more places than you&rsquo;re aware of) and for now many of the addons your use won&rsquo;t work, starting
with some addons as important as <code>ember-data</code>.
An intermediate step could be to use a lighter version of jQuery with some features removed.
For you it might make more sense to use the <em>slim</em> version of jQuery, which can save you
7KB with very little effort.</p>

<p><strong>If you are starting a new app right now and it targets mobile, it might make sense to try</strong>.
You will save more than 35KB of min+gzip size, with it&rsquo;s associated parse and eval code and
that can save half a second in a cold boot even with decent device and connection and around
a second if other of those is bad.</p>

<p><strong>If, on the other hand, your app targets desktop, it is unlikely that a jQuery-less app will bring you a lot of advantages</strong> and it will make your development harder, as a lot of addons need jQuery to work, so you will have to make
PRs to fix other people&rsquo;s addons as you go. It is important to keep in mind that jQuery
is not over 100K of random code someone wrote for the fun of it. It actually fixes tons of browser
quirks (run <code>curl -L https://code.jquery.com/jquery-git.js | grep -A 5 -n Support:</code> to
see some). It&rsquo;s a fantastic piece of software that we shouldn&rsquo;t disregard as obsolete.</p>

<p>That said, most of those quirks affect IE9 and 10 or ancient versions of safari and the
android browser which are legacy today and Ember shields you from almost all of them by
handing DOM manipulation, so a lot of Ember addons rely on jQuery for very simple tasks
just because <em>it has always been there</em>, not because it is intrinsic to their goal.
Usually fixing those addons takes little time.</p>

<p><strong>If you are maintaining an addon, you totally should</strong>. Since the main problem people
will face building apps without jQuery is that addons break, try to make your addons to not
be one of those that break.</p>

<p>Now, let&rsquo;s get to the topic</p>

<h2>Disclaimer about Ember version</h2>

<p>At the time of this writing, you need Ember.js >= 2.13.0-beta.2. Soon (a few weeks) the fix
will be in stable.
I&rsquo;d also strongly recomend to be on ember-cli 2.13-beta too so you use ember-cli-babel 6. It&rsquo;s
not <strong>required</strong>, but in this tutorial I&rsquo;m going to do it and explain why it&rsquo;s cool.</p>

<h2>Steps</h2>

<p>Since the main missing point of the transition away from jQuery was testing, this post is
also going to explain a new way of doing testing that is an experiment towards the <a href="https://github.com/rwjblue/rfcs/blob/42/text/0000-grand-testing-unification.md">Grand
Testing Unification RFC</a>
that has been long awaited and today we can almost touch it with the tips of our fingers.</p>

<p>On every step I&rsquo;ll explain you <strong>why</strong> this step is required, because some of them are
needed today but will probably not be required in the future as tools adapt. If you read
this post in a few weeks or months in the future, recheck if things have changed and skip
the step if possible.</p>

<p>The first step is top update your app/addon to use 2.13. Run <code>ember install ember-source@2.13.0-beta.2</code></p>

<p>The reason for that is <a href="https://github.com/emberjs/ember.js/pull/15065">this fix</a> that
makes Ember only setup <code>ajaxSend</code> and <code>ajaxComplete</code> events <strong>only</strong> if jQuery is present.
Without it jQuery-less apps where basically untestable.</p>

<p>The second step (entirely optional, feel free to skip): <a href="https://github.com/ember-cli/ember-cli/releases/tag/v2.13.0-beta.3">Update ember-cli to 2.13-beta</a>.
Go, I&rsquo;ll wait.</p>

<p>One nice feature of this beta version is the new <a href="https://github.com/ember-cli/rfcs/blob/master/complete/0095-standardise-targets.md">targets feature</a>
In short, this feature allows you to express in what browsers your app is going to run so
tooling can be smart about it in many ways. The best example of this is that ember-cli-babel 6 will
only transpile what is necessary for running the app in the given and nothing else, so if
you target only modern browsers features that now law, like arrow functions, will be untouched.</p>

<p>If you are like me, you will usually develop in the latest chrome. If you do so, you don&rsquo;t need
most of the transpilation that Babel does by default even if you do for production, so for
a better debugging experience I use this settings:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">browsers</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EMBER_ENV</span> <span class="o">===</span> <span class="s1">&#39;development&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">browsers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;last 1 Chrome versions&#39;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">browsers</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="s1">&#39;ie 11&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;last 1 Chrome versions&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;last 1 Firefox versions&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;last 1 Safari versions&#39;</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">browsers</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Your app will be transpiled in production and when running tests in CI but in development,
apart from <code>import/export</code>, your code will remain almost untouched. I&rsquo;ve disabled JS sourcemaps
since I don&rsquo;t find them useful anymore with this settings.</p>

<p>The reason why I recomend following this step even if it&rsquo;s not necessary is because we&rsquo;re going
to rely a lot in some new features of the language and avoiding transpilation will make
your debugging experience better.
I actually recommend those settings regardless of if you plan to remove jQuery or not. It just
feels like living in a better future.</p>

<p>The third step is to replace the jQuery-based ember dispatcher that lives inside Ember with
one based in native events. As usual Robert Jackson got you covered and he developed
<a href="https://github.com/rwjblue/ember-native-dom-event-dispatcher">ember-native-dom-event-dispatcher</a>
a while ago.</p>

<p>Run <code>ember install ember-native-dom-event-dispatcher</code> and your app will not use jQuery events anymore.</p>

<p>This will make components methods named after events (like <code>click(event) {}</code> or <code>mouseEnter(event) {}</code>) work
as usual with the subtle difference that the received <code>event</code> is no longer a jQuery event but a native one.
For the most part they are pretty interoperable, but there is some subtle differences in props/methods
and how <code>event.target</code> works, so pay attention.
To name the caveat that is most likely to bite you, to check if some code called <code>.preventDefault()</code> on an event,
in native events you use the <code>e.defaultPrevented</code> property while in jQuery events you use the <code>e.isDefaultPrevented()</code>
method.</p>

<p>The forth step if to install the last version I published of <a href="https://github.com/cibernox/ember-native-dom-helpers">ember-native-dom-helpers</a>.</p>

<p>Run <code>ember install ember-native-dom-helpers</code> and you will be introduced to a new way testing that
will delight you and I&rsquo;ll cover in a moment. This new way of testing is going to use <code>async/await</code>
instead of <code>andThen</code>, so any but the very latest browsers will need the regenerator
polyfill.</p>

<p>Run <code>ember install ember-maybe-import-regenerator</code> to get it. This addon already
uses the new targets feature so it will not import it if the browsers you target support async/await already.
I&rsquo;m biased because I started the work on <code>ember-native-dom-helpers</code>, but <strong>regardless of if you plan to remove jQuery, you should try it</strong>.
It&rsquo;s going to make you love your tests again, particularly integration tests.</p>

<p>The next step is to remove <code>ember-ajax</code>. The addon is included in the default blueprint but it is a wrapper around
<code>$.ajax</code>, so it&rsquo;s evident that we need to find a replacement.</p>

<p>I&rsquo;ve switched on my projects to
<a href="https://github.com/stefanpenner/ember-fetch"><code>ember-fetch</code></a> and it&rsquo;s very nice.
However at the time of this writing you must use the branch <code>patch-2</code> of my own
fork of the project (<a href="https://github.com/cibernox/ember-fetch/tree/patch-2">cibernox/ember-fetch#patch-2</a>) while those changes are not
merged into master.</p>

<p>It is important to note that <strong>you must not use the global <code>window.fetch</code> even if your browser matrix supports it</strong>.
You must use the <code>import fetch from 'fetch';</code> import path that the addon provides.</p>

<p>You might wonder why we can&rsquo;t just &ldquo;Use the platform&rdquo;. If you don&rsquo;t care about testing then using <code>window.fetch</code>
is fine, but in testing you will want to perform some operation that makes a network request
and then wait for it to finish before asserting that your UI has updated accordingly.
In order to do that Ember must instrument when a fetch request starts and finishes so it can
wait for them, and that is what this imported <code>fetch</code> function does. It&rsquo;s just <a href="https://github.com/cibernox/ember-fetch/blob/15c04b029c3eed4b09f9e37d1636194cf95ac725/assets/browser-fetch.js.t#L23-L35">a thin wrapper</a>
over the global fetch with a polyfill for old browsers.</p>

<p>Another reason to not use the native fetch is that you will want to mock network requests in development/test
and <a href="http://www.ember-cli-mirage.com/"><code>ember-cli-mirage</code></a> is very popular for that. That addon
uses a mocking library called <a href="https://github.com/pretenderjs/pretender">Pretender.js</a> which
at the time of this writing cannot mock requests made with the native <code>fetch</code>, but it can
however if you use the fetch polyfill that <code>ember-fetch</code> (which uses a regular XHR request underneath) provides you.
There is some ideas to fix pretender on this regard, so hopefully this will change soon.</p>

<p>BTW, there is a caveat about <code>fetch</code> (native or otherwise) that although I am aware of, I keep forgetting.
Unlike <code>$.ajax('/some-url').then(fn1).catch(fn2)</code> where 2XX and 3XX status codes trigger the <code>then</code> callback
and 4XX and 5XX statuses are considered failures and trigger the <code>catch</code>, using the <code>fetch</code> the
only situation that causes a request to fail and the <code>catch</code> handler to be called is a real
network error, like being offline or a timeout. Any request that was properly sent and
received, even if its status is a catastrofic 500 will call the <code>then</code> method, so you need to use
the <code>response.ok</code> flag to disambiguate. E.g:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">fetch</span><span class="p">(</span><span class="s2">&quot;/some-endpoint&quot;</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
</span><span class='line'><span class="p">}).</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>One last thing you have to remove is <code>ember-data</code>, for similar reasons. There is a plan to
decouple <code>ember-data</code> from <code>$.ajax</code>, but we&rsquo;re not there yet.</p>

<p>Enough with addons, let&rsquo;s remove jQuery itself. Open your <code>ember-cli-build.js</code> and make
it look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">const</span> <span class="nx">EmberAddon</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ember-cli/lib/broccoli/ember-addon&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EmberAddon</span><span class="p">(</span><span class="nx">defaults</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">vendorFiles</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;jquery.js&#39;</span><span class="o">:</span> <span class="kc">null</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">app</span><span class="p">.</span><span class="nx">toTree</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Done, no more jQuery. Now if you are on an empty app or addon you should be able boot it
and start working on it. If you are on an existing one, chances are some addon will
break, but the errors messages I&rsquo;ve seen were always pretty evident.</p>

<p>The actual problem until now with jquery-less apps was testing, and this is the problem,
among others, that <code>ember-native-dom-helpers</code> wants to solve.</p>

<p>This addon provides you with a collection of test helpers that you can use in both acceptance
and integration tests and those helpers, unlike the ones in Ember.js itself, don&rsquo;t use jQuery internally.
It even offers a few useful new helpers like <code>tap</code> and <code>waitUntil</code> that will make your life
easier.</p>

<p>One key feature the interaction helpers of that addon (<code>click</code>, <code>fillIn</code>, <code>tap</code> &hellip;) is
that they return the promise generated by <code>wait()</code>, which is a promise that resolves once
the &ldquo;world has settled&rdquo; (No pending waiters, no pending route transitions, no pending ajax requests&hellip;).</p>

<p>This along with the new <code>async/await</code> syntax in ES2017 allows you to make your tests much
more readable.</p>

<p>Instead of</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">moduleForAcceptance</span><span class="p">(</span><span class="s1">&#39;Acceptance | Sign up&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;Usage awaiting the world to settle&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">visit</span><span class="p">(</span><span class="s1">&#39;/sign-up&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">andThen</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">fillIn</span><span class="p">(</span><span class="s1">&#39;.first-name&#39;</span><span class="p">,</span> <span class="s1">&#39;Chuck&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">fillIn</span><span class="p">(</span><span class="s1">&#39;.last-name&#39;</span><span class="p">,</span> <span class="s1">&#39;Berry&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">click</span><span class="p">(</span><span class="s1">&#39;.submit-btn&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">andThen</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.welcome-msg&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;There is a welcome banner&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.welcome-msg-name&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">trim</span><span class="p">(),</span> <span class="s1">&#39;Chuck&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>you can write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="p">{</span> <span class="nx">visit</span><span class="p">,</span> <span class="nx">click</span><span class="p">,</span> <span class="nx">find</span><span class="p">,</span> <span class="nx">fillIn</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;ember-native-dom-helpers&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">moduleForAcceptance</span><span class="p">(</span><span class="s1">&#39;Acceptance | Sign up&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;Usage awaiting the world to settle&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">await</span> <span class="nx">visit</span><span class="p">(</span><span class="s1">&#39;/sign-up&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fillIn</span><span class="p">(</span><span class="s1">&#39;.first-name&#39;</span><span class="p">,</span> <span class="s1">&#39;Chuck&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fillIn</span><span class="p">(</span><span class="s1">&#39;.last-name&#39;</span><span class="p">,</span> <span class="s1">&#39;Berry&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">await</span> <span class="nx">click</span><span class="p">(</span><span class="s1">&#39;.submit-btn&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.welcome-msg&#39;</span><span class="p">),</span> <span class="s1">&#39;There is a welcome banner&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.welcome-msg-name&#39;</span><span class="p">).</span><span class="nx">textContent</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span> <span class="s1">&#39;Chuck&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the benefit that you don&rsquo;t need to change your mindset when writing integration tests,
since the same helpers behave the same way on both kind of tests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="p">{</span> <span class="nx">click</span><span class="p">,</span> <span class="nx">fillIn</span><span class="p">,</span> <span class="nx">find</span><span class="p">,</span> <span class="nx">findAll</span><span class="p">,</span> <span class="nx">keyEvent</span><span class="p">,</span> <span class="nx">triggerEvent</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;ember-native-dom-helpers&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">moduleForComponent</span><span class="p">(</span><span class="s1">&#39;my-component&#39;</span><span class="p">,</span> <span class="s1">&#39;Integration | Component | my-component&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">integration</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;I can interact with my component&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">assert</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">hbs</span><span class="err">```</span><span class="p">{{</span><span class="nx">my</span><span class="o">-</span><span class="nx">component</span><span class="p">}}</span><span class="err">```</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">await</span> <span class="nx">fillIn</span><span class="p">(</span><span class="s1">&#39;.some-input&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">await</span> <span class="nx">click</span><span class="p">(</span><span class="s1">&#39;.main-button&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">await</span> <span class="nx">keyEvent</span><span class="p">(</span><span class="s1">&#39;.other-input&#39;</span><span class="p">,</span> <span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span> <span class="c1">// down arrow</span>
</span><span class='line'>  <span class="nx">await</span> <span class="nx">triggerEvent</span><span class="p">(</span><span class="s1">&#39;.some-drop-area&#39;</span><span class="p">,</span> <span class="s1">&#39;mouseenter&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.result-of-event-happened&#39;</span><span class="p">));</span>
</span><span class='line'>  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">findAll</span><span class="p">(</span><span class="s1">&#39;.result-list-item&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since those helpers don&rsquo;t use jQuery and now we are making requests with <code>ember-fetch</code>, we
can write and tests apps nicer than ever!</p>

<p>Note that to prevent ESLint to freak out when using <code>async/await</code>, you must edit your <code>.eslintrc.js</code>
file and instruct to parse the javascript as the new ES2017 spec:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">root</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">parserOptions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">ecmaVersion</span><span class="o">:</span> <span class="mi">2017</span><span class="p">,</span> <span class="c1">// &lt;--- yeah!</span>
</span><span class='line'>    <span class="nx">sourceType</span><span class="o">:</span> <span class="s1">&#39;module&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="kr">extends</span><span class="o">:</span> <span class="s1">&#39;eslint:recommended&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">env</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">browser</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">rules</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you are starting a new project and since the name of the test helpers provided by
<code>ember-native-dom-helpers</code> are the same of the global helpers provided by Ember, but you
really don&rsquo;t want to use those by mistake, I recommend to remove the configuration line
that explicitly whitelists those helpers as globals, so it will prevent you from using
the global <code>window.click/fillIn</code> that rely on jQuery by mistake.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'>module.exports = {
</span><span class='line'><span class="gd">-  env: {</span>
</span><span class='line'><span class="gd">-    embertest: true</span>
</span><span class='line'><span class="gd">-  },</span>
</span><span class='line'>  globals: {
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This is pretty much all you need to know about the future of testing and removing jQuery
from your app addons.
Now it is the turn of the community of steadily but relentlessly make all the addons that
are not intentionally wrappers around jQuery plugins to work without it, so soon we move
from making jQuery an opt-out to make it an opt-in, which is part of the broader strategy
to create an easy path for apps to escalate from a barebone Glimmer.js component to the
full-featured Ember.js application as they need.</p>

<h2>Is it really any faster?</h2>

<p>Yes, it is. This screen were taking on <a href="http://www.ember-basic-dropdown.com">www.ember-basic-dropdown.com</a> running locally with CPU throttling set to 5X and networt set to &ldquo;Good 3G&rdquo;. That is more or less like using a high end Android devise on a <em>meh</em> connection. A pretty common situation in the first world.</p>

<p>With jQuery:
<img src="http://miguelcamba.com/images/with-jquery-small.jpg" alt="with jQuery" style="width: 100%"/></p>

<p>Without jQuery:
<img src="http://miguelcamba.com/images/without-jquery-small.jpg" alt="without jQuery" style="width: 100%"/></p>

<p>The TTI (time to interactive) is consistently around 0.7 seconds smaller on a cold boot. With a slower device or a worse connection the difference is a bit over one second.</p>

<h2>How can I help?</h2>

<p>This is for addon maintainers. If you know that your addon doesn&rsquo;t have any reason to use
jQuery, what you can do is follow the steps in this tutorial, fix any possible unintended
usage of jQuery in your addon and then make sure you test without jQuery in CI.</p>

<p>You can use <a href="https://github.com/cibernox/ember-basic-dropdown/pull/260">this PR to ember-basic-dropdown</a>
as an example of the changes that an addon with a mild usage of jQuery had to do to.
<a href="https://github.com/cibernox/ember-basic-dropdown/pull/240/files">This</a> and <a href="https://github.com/cibernox/ember-basic-dropdown/pull/253">this</a>
PRs that slowly introduced <code>ember-native-dom-helpers</code> before chopping jQuery might also
be helpful to see how to refactor a codebase to the new testing style.</p>

<h2>What is the big picture of things to make this a default.</h2>

<p>This is just what <strong>I think</strong> should be required to the MVP of a jquery-less world that doesn&rsquo;t suck to live in.</p>

<ul>
<li>Enhance pretender (used by ember-cli-mirage) to reliably mock fetch. In practice it means to create the fetch counterpart of <a href="https://github.com/pretenderjs/FakeXMLHttpRequest">https://github.com/pretenderjs/FakeXMLHttpRequest</a></li>
<li>Enhance <code>ember-fetch</code> to have some sort of feature-parity with <code>ember-ajax</code>, particularly exposing a service that allows to encapsulate authentication, headers and all that.</li>
<li>Refactor <code>ember-data</code>&rsquo;s internals to use some sort of <code>network</code> service that masks how that actually works inside. It could be implemented in terms of <code>$.ajax</code>, <code>fetch</code> or raw <code>XHR</code>. This service should be provided by the networking libraries (<code>ember-ajax</code>, <code>ember-network</code>, <code>ember-fetch</code>&hellip;). For backwards compatibility reasons probably this service&rsquo;s semantics should mimic <code>$.ajax</code>, but not sure.</li>
<li>Put a carrot for developers to make their addons jquery-free. One idea I have is giving them one extra point in ember-observer.
We could detect this checking if <code>ember-native-dom-event-dispatcher</code> is present in some of the ember-try scenarios.</li>
<li>Ensure that the top 15? 20? 25? addons in popularity work without jQuery. Like with mobile apps&#8217; usage, upgrading a few of most popular addons would cover a significant percentage of the apps.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Trick for Build Composable Components - Part 1]]></title>
    <link href="http://miguelcamba.com/blog/2016/04/13/tricks-for-build-composable-components-part-1/"/>
    <updated>2016-04-13T10:24:56+01:00</updated>
    <id>http://miguelcamba.com/blog/2016/04/13/tricks-for-build-composable-components-part-1</id>
    <content type="html"><![CDATA[<p>Component composition has been my personal area of interest lately when using Ember.
<a href="https://www.ember-power-select.com">Ember Power Select</a> started like me scratching my own itch and
trying to fill what I felt like a meaningful gap in the ecosystem but also became my playground to
try ideas and decide what works and what doesn&rsquo;t.</p>

<p>This posts starts a (probably short) series of post with things I&rsquo;ve learned in the process. Some will
be concrete tricks, others will be just general advices.</p>

<p>Patronizing bores people, so I&rsquo;ll start with one simple trick.</p>

<!-- more -->


<h2>Allow mass assignment of properties</h2>

<p>No, this is not about the well-known old rails security outage.</p>

<p>Imagine you have built a component that, despite of how hard you tried to avoid it, ends up accepting
quite a few options. You are a good Ember fellow so you decide to leverage convention over configuration
and make most those option have sensible default values.</p>

<p>Example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// cool-component/compoenent.js</span>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">placeholder</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">disabled</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">role</span><span class="o">:</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">autofocus</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">dir</span><span class="o">:</span> <span class="s1">&#39;ltr&#39;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>{% raw %}</p>

<p>Your goal is to allow a user to be able to create their own wrapper components that <em>compose</em> yours,
so they can reuse some set of configuration options and actions that yield the behavior they want in
a less verbose manner. That user is also a very good ember citizen and decides that there is value
on that customized version of your component and it can be published as an addon.</p>

<p>That user will also want to give some degree of freedom to the consumer of his work and allow to, on turn,
customize the default values.</p>

<p>To allow that, the wrapper component must forward all possible attributes to the inner component, like
this:</p>

<p>{% raw %}</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>// my-wrapper/template.hbs
</span><span class='line'>{{cool-component
</span><span class='line'>  disabled=disabled
</span><span class='line'>  role=role
</span><span class='line'>  autofocus=autofocus
</span><span class='line'>  dir=dir
</span><span class='line'>  value=value
</span><span class='line'>  placeholder=placeholder
</span><span class='line'>}}
</span></code></pre></td></tr></table></div></figure>


<p>So the user just does:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{{my-wrapper value=foo dir=&quot;rtl&quot;}}
</span></code></pre></td></tr></table></div></figure>


<p>And here it comes the problem. If the consumer of the wrapper component doesn&rsquo;t specify every single possible
option those non-specified options being forwarded contain <code>undefined</code> and will override the default
values of the inner with it.</p>

<p>This is not really easy to fix by the creator of the wrapper component, because to fix that from the outside,
the wrapper component has to copy the default values for every option accepted by the inner component, like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// cool-component/compoenent.js</span>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">disabled</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>    <span class="c1">// Same default value as the inner component</span>
</span><span class='line'>  <span class="nx">role</span><span class="o">:</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span>      <span class="c1">// Same default value as the inner component</span>
</span><span class='line'>  <span class="nx">autofocus</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>    <span class="c1">// Same default value as the inner component</span>
</span><span class='line'>  <span class="nx">dir</span><span class="o">:</span> <span class="s1">&#39;ltr&#39;</span><span class="p">,</span>         <span class="c1">// Same default value as the inner component</span>
</span><span class='line'>  <span class="nx">placeholder</span><span class="o">:</span> <span class="s1">&#39;Type to search&#39;</span><span class="p">,</span> <span class="c1">// This default is different</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This requires a lot of intimate knowledge of the internals of the inner component. You need to know
all options along with their values and update them if they change.</p>

<p>This can however be addressed in a more robust way by the creator of the inner component by defining
the default values in a way that don&rsquo;t get overridden by <code>undefined</code> values.</p>

<p>This can be done with a <code>defaultTo</code> computed property macro in a very clean way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">defaultTo</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">computed</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">get</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">value</span><span class="p">;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nx">set</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">newVal</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="nx">newVal</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">placeholder</span><span class="o">:</span> <span class="nx">defaultTo</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">disabled</span><span class="o">:</span> <span class="nx">defaultTo</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">role</span><span class="o">:</span> <span class="nx">defaultTo</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">autofocus</span><span class="o">:</span> <span class="nx">defaultTo</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">dir</span><span class="o">:</span> <span class="nx">defaultTo</span><span class="p">(</span><span class="s1">&#39;ltr&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this little macro people wrapping your component can carelessly forward all options
to the it with the peace of mind that default values are safe even if the user doesn&rsquo;t fill
all the blanks.</p>

<p>There is still two downsides with this idea.</p>

<p>The first one is that this is preventing the user to pass <code>undefined</code> to override a default value. I&rsquo;d
argue that this is not a big problem because usually <code>null</code> can be used for the same purpose, although I
imagine there is some edge case where <code>undefined</code> is a perfectly valid value. I just haven&rsquo;t found one yet.</p>

<p>The second is that while it saves the component composing yours from having to know every
default value, it still requires it to specify forward <em>every</em> option in the template.
Not yet ideal, but at least you removed one half of the problem.</p>

<p>I hope some new HTMLBars/glimmer construction in the future, like the spread operator mentioned
in some RFCs will improve the ergonomics of this.</p>

<p>Stay tuned for part 2.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ember Closure Actions in Depth]]></title>
    <link href="http://miguelcamba.com/blog/2016/01/24/ember-closure-actions-in-depth/"/>
    <updated>2016-01-24T09:24:56+00:00</updated>
    <id>http://miguelcamba.com/blog/2016/01/24/ember-closure-actions-in-depth</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve been using Ember&rsquo;s closure actions in all my projects for a while now and I like them so much
that I almost take for granted that everybody has embraced them too.</p>

<p>While it&rsquo;s true that most ember devs have started using them, I&rsquo;ve seen that many people haven&rsquo;t fully
grasped all its potential and the new patterns they enable, so I want to explain them a bit more,
starting from the basics and going towards more advanced patterns.</p>

<!-- more -->


<h2>What is a closure action?</h2>

<p>First things first, let&rsquo;s see a few actions in the wild.</p>

<p>Which ones of these are closure actions?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="err">{{</span><span class="na">action</span> <span class="err">&quot;</span><span class="na">sayHi</span><span class="err">&quot;}}</span><span class="nt">&gt;</span>Salute<span class="nt">&lt;/button&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">sayHi</span><span class="err">&quot;}}</span><span class="nt">&gt;&lt;/button&gt;</span>
</span><span class='line'>{{my-button action=(action &quot;sayHi&quot;)}}
</span><span class='line'>{{my-button action=&quot;sayHi&quot;}}
</span></code></pre></td></tr></table></div></figure>


<p>If you said 2nd and 3rd you guessed right.</p>

<p>The 4th example is clearly just a regular attribute passing. It is named <code>action</code> but could be named <code>weasel</code>
and would be exactly the same, just a string.</p>

<p>The 1st line is a bit more fuzzy. That line is telling Ember to invoke the &ldquo;sayHi&rdquo; action when the button
is clicked. <strong>Why doesn&rsquo;t it qualify as a closure action?</strong></p>

<p>We have to start by explaining that the <code>action</code> helper is overloaded and, depending on which context it is used in,
it does entirely different things.</p>

<h3><code>action</code> in the &ldquo;element space&rdquo;</h3>

<p>When invoked within the context of an html element (what is known as the <em>&ldquo;element&rsquo;s space&rdquo;</em>),
the <code>action</code> keyword does a quite a lot of stuff.
It registers in the global Ember dispatcher one (or some) handlers for events whose target is the element in
which it was invoked.</p>

<p>In the first line of the previous example, the helper is registering in the event handler for the <code>click</code>
attached automatically by Ember to the root of your app, a handler that will be invoked when
the target of the event is that button. It&rsquo;s also doing the same thing for the <code>keypress</code> event when
the pressed key is <kbd>enter</kbd>. That handler, in turn, will call the <code>sayHi</code> action on the context of that template.</p>

<p>Apart from all that, the action helper will call <code>preventDefault()</code> on that event, hijacking its default
behavior, like by example submitting the form in which that button lives. However, that will not
prevent the event from bubbling.</p>

<p>Both behaviors can be tuned from the template with options:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="err">{{</span><span class="na">action</span> <span class="err">&quot;</span><span class="na">sayHi</span><span class="err">&quot;</span> <span class="na">preventDefault=</span><span class="s">false</span> <span class="na">bubble=</span><span class="s">false}}</span><span class="nt">&gt;</span>Salute<span class="nt">&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>By default the <code>action</code> helper registers for DOM click events but you can specify a different event name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="err">{{</span><span class="na">action</span> <span class="err">&quot;</span><span class="na">sayHi</span><span class="err">&quot;</span> <span class="na">on=</span><span class="s">&quot;double-click&quot;</span><span class="err">}}</span><span class="nt">&gt;</span>Salute<span class="nt">&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we see, there is quite a process involved here, but this is not a closure action.</p>

<h3><code>action</code> as a closure creator</h3>

<p>On the other hand, the second usage of this helper is as <em>closure creator</em>. This is the behavior the
helper has in <strong>any</strong> other situation different than the one described above.</p>

<p>It does something much simpler but also much more powerful. <strong>It creates a function with a closure that invokes another function</strong></p>

<p>That&rsquo;s it. You can think about it almost like this snippet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">createClosureAction</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">func</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">...</span><span class="nx">args</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note: This is an oversimplification. Closure actions don&rsquo;t even use <code>Function#bind</code> at all, but it&rsquo;s close enough to grasp the basics.</em></p>

<p>It does nothing else. It doesn&rsquo;t register any event handler, doesn&rsquo;t prevent default or stop bubbling. It just
binds the given function to the current context and arguments. When provided with a string it will assume that
it&rsquo;s the name of an action and will extract it from the current context.</p>

<p>So, if it is such a simple helper, why is it so cool?</p>

<h3>The good parts of being a function</h3>

<p>Converting your actions to functions you can pass around has many advantages.</p>

<h4><strong>Simpler mental model</strong></h4>

<p>This one is often understated.</p>

<p>A function is a value. <code>{{my-component foo=bar}}</code>
in a template means that we&rsquo;re passing to the component a property named <code>"foo"</code> whose value is the value in <code>bar</code>. What if <code>bar</code>
is a function? Nothing: it&rsquo;s the same idea. We&rsquo;re just passing a value.</p>

<p>What if we do <code>{{yield (action &ldquo;submit&rdquo;)</code>? Same thing, we&rsquo;re just yielding a value that happens
to be a function. That is all.</p>

<h4><strong>Detect errors eagerly</strong></h4>

<p>On this usage, <code>{{action &ldquo;foo&rdquo;}}</code> is a helper and as such, tries to do its work as soon as the
template is rendered. If the current context doesn&rsquo;t have a function named <code>foo</code> it will fail right away,
unlike <em>element&rsquo;s space</em> usage where it will fail at runtime when that event is fired and, oh surprise,
there is no action named <code>foo</code>!!</p>

<p>It still surprises me how many refactoring bugs this simple feature has caught for me.</p>

<h4><strong>Return values</strong></h4>

<p>Functions have return values. Closure actions are functions. Therefore <em>modus ponendo ponens</em>, closure actions have
return values too.</p>

<p>If the component calls <code>this.get("foo")("someArg")</code>, it is just invoking a function and will have access
to its return value, if any. This enables bidirectional communication with the parent context.</p>

<p>As a real world example, an <code>{{async-button action=(action &ldquo;submit&rdquo;)}}</code> will invoke the action and that
action can return a promise. Thanks to having access to that promise, the button can then change to a &ldquo;loading&rdquo;
state while that returned promise is pending.</p>

<h4><strong>Removes logic from middlemen</strong></h4>

<p>Actions can be passed down/up as many levels as desired.</p>

<p>When passing actions as just strings with their names to be invoked with the <code>sendAction(actionName)</code> in the receiver
component, each call to <code>sendAction</code> will only reach the closest component in the hierarchy.
This means that when the logic to be executed lives a few layers up from where the event that triggers it
is fired, each one of the intermediate components has to define an action to capture and re-thorw the
call to the next level.</p>

<p>That is a lot of coupling.</p>

<p>Closure actions just being functions bound to a given scope means that they can just be passed as simple
values from the root to the leaves. Then, the last component in the chain can invoke that action with
via <code>this.get("functionName")()</code> and it will be executed with the provided arguments in the correct
scope, releasing intermediate nodes in the chain of the burden of capture-and-rethrow actions by its name.</p>

<h4><strong>Closure actions as event handlers</strong></h4>

<p>When we attach a closure action to an event handler like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">sayHi</span><span class="err">&quot;}}</span><span class="nt">&gt;&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ember.js is just doing</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">button</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="nx">wrappedSayHiFunction</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That means that, as with all event handlers attached to DOM elements, it is invoked with the <code>event</code>
as first argument. But since the handler function already has one argument bound, the event is received
as the second argument instead.</p>

<p>There is little-to-no magic happening here, just regular javascript.</p>

<p>That also means that is up to the user to call <em>preventDefault</em> or <em>stopPropagation</em> on the received event.</p>

<h4><strong>Not only actions can be actions</strong></h4>

<p>Tipically when using the <code>action</code> helper you will pass a string containing the name of some function
that lives in the <code>actions</code> property of your component, like this: <code>&lt;button onclick={{action "sayHi"}}&gt;&lt;/button&gt;</code></p>

<p>But did you know that you can extract any function from your component by passed an unquoted reference?</p>

<figure class='code'><figcaption><span>template.hbs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="na">sayHi</span><span class="err">}}</span><span class="nt">&gt;&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>component.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// empty</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">sayHi</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Hi!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is useful by example if you want a component to execute some arbitrary logic that can be decided
by its parent, and passed as an argument.</p>

<figure class='code'><figcaption><span>my-button/template.hbs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="na">clickHandler</span><span class="err">}}</span><span class="nt">&gt;&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>salutator/template.hbs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{{my-button clickHandler=sayHi}}
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>salutator/component.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">sayHi</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Hi!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that you know that it&rsquo;s possible, <strong>I strongly discourage you to do this.</strong></p>

<p>This enters the personal opinion realm but I feel that <strong>if we start extracting methods of components
to use them as actions, why do we have the <code>actions</code> hash at all?</strong></p>

<p>Instead, when I want to be able to customize from outside a component what an action will do, I define
an action inside the component that just delegates all its logic to a method that can be passed in from
the outside.</p>

<figure class='code'><figcaption><span>my-button/template.hbs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">clickHandler</span><span class="err">&quot;}}</span><span class="nt">&gt;&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>my-button/component.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">clickHandler</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">clickHandler</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">clickHanldler</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;clickHandler must be provided!!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>salutator/template.hbs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{{my-button clickHandler=sayHi}}
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>salutator/component.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">sayHi</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Hi!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The behavior is the same but reading the code of the component is crystal clear that <code>clickHandler</code>
is intended to be passed from the outside. I find this approach self-documented and more idiomatic.</p>

<h4><strong>Currying</strong></h4>

<p>Taken from the wikipedia:</p>

<p><em>Currying is the technique of translating the evaluation of a function that takes multiple arguments (or a tuple of arguments) into evaluating a sequence of functions</em></p>

<p>Without deep diving into Haskell theory and monad madness, let me only explain how you can apply this
technique for your own benefit with an example.</p>

<p>Having this declaration in the templates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{{my-form onSubmit=(action &quot;submitWithAjax&quot; &quot;/users/registration&quot;)}}
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- Within my-form.hbs --&gt;</span>
</span><span class='line'>{{my-button onUsage=(action onSubmit data)}}
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- Within my-button.hbs --&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{onUsage}}</span><span class="nt">&gt;&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the <code>sendWithAjax</code> function of the top-most scope:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">submitWithAjax</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// how come do I receive 3 arguments?!?!111</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Because currying</em>.</p>

<p>Each invocation of the <code>action</code> helper created a new closure and bound the given
arguments to the function. The first invocation bound the <code>this</code> to the current context and the
first arguments to the string <code>"/users/registration"</code>. The second invocation bound the data to the function.
Since the context and the first argument were already bound, that argument takes the 2nd position.
Last, but not least, that function is assigned to the <code>onclick</code> property of that DOM element, and when
it&rsquo;s invoked the event is passed, occupying the last position in the arguments list.</p>

<p>Translated to javascript, it&rsquo;s more or less equivalent to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">let</span> <span class="nx">funcOne</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="s2">&quot;/users/registration&quot;</span><span class="p">);</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="kd">let</span> <span class="nx">funcTwo</span> <span class="o">=</span> <span class="nx">funcOne</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">secondContext</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="nx">button</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="nx">funcTwo</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using currying each level can augment the action with some extra arguments, and that frees the last
level of the chain of the responsibility of holding all the information needed to perform the action.
Each piece of data can live in the level where it makes more sense, without leaking outside it.</p>

<h4><strong>Extracting values out of the first argument</strong></h4>

<p>The <em>action</em> helper accepts a set of key/value pairs as last argument. One special option you can use
is the <code>value</code> option. This option holds a path, and the closure action will be invoked with the
value contained in that path on the first argument instead of the first argument.</p>

<p>The most common example of this is to extract some value out of the event.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">onchange=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">logArgs</span><span class="err">&quot;}}</span><span class="nt">&gt;</span> <span class="c">&lt;!-- Logs `[event]` --&gt;</span>
</span><span class='line'><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">onchange=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">logArgs</span><span class="err">&quot;</span> <span class="na">value=</span><span class="s">&quot;target.value&quot;</span><span class="err">}}</span><span class="nt">&gt;</span> <span class="c">&lt;!-- Logs the value of the input (e.target.input) --&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>But often people doesn&rsquo;t realize that it works with anything, not only events. Per example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">logArgs</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="na">abcde</span><span class="err">&quot;</span> <span class="na">value=</span><span class="s">&quot;length&quot;</span><span class="err">}}</span><span class="nt">&gt;</span> <span class="c">&lt;!-- Logs `[5]` --&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">(</span><span class="na">action</span> <span class="err">&quot;</span><span class="na">logArgs</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="na">foo</span><span class="err">&quot;</span> <span class="na">value=</span><span class="s">&quot;length&quot;</span><span class="err">)</span> <span class="na">value=</span><span class="s">&quot;screenX&quot;</span><span class="err">}}</span><span class="nt">&gt;</span>Press me<span class="nt">&lt;/button&gt;</span> <span class="c">&lt;!-- Logs `[3, 741]` --&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is specially useful when combined with the next point.</p>

<h4><strong>DDAU and the <code>mut</code> helper</strong></h4>

<p>The Data Down - Actions Up approach to propagate state changes in an app advices us to not rely on two-way
bindings for mutating state but on explicit function invocations. Consider the next code example:</p>

<figure class='code'><figcaption><span>template.hbs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;p&gt;</span>Select shipment type<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">selectShipmentType</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="na">regularDelivery</span><span class="err">&quot;}}</span><span class="nt">&gt;</span>Standard delivery<span class="nt">&lt;/button&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">selectShipmentType</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="na">urgent</span><span class="err">&quot;}}</span><span class="nt">&gt;</span>48h delivery<span class="nt">&lt;/button&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">&quot;</span><span class="na">selectShipmentType</span><span class="err">&quot;</span> <span class="err">&quot;</span><span class="na">next-day</span><span class="err">&quot;}}</span><span class="nt">&gt;</span>Next day delivery<span class="nt">&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>component.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">selectShipmentType</span><span class="p">(</span><span class="nx">type</span> <span class="cm">/*, e */</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;shipmentType&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty common. Changing the selection invokes the <code>selectShipmentType</code> action with one value, and that
action mutates some value. However, setting some state as result of some user interaction is so common
that there is a built-in way to avoid having to define such simple functions over and over: the <code>mut</code> helper.</p>

<p>This helper creates a function that will set on some property the first argument it receives. The following
code is equivalent.</p>

<figure class='code'><figcaption><span>template.hbs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;p&gt;</span>Select shipment type<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">(</span><span class="na">mut</span> <span class="na">shipmentType</span><span class="err">)</span> <span class="err">&quot;</span><span class="na">regularDelivery</span><span class="err">&quot;}}</span><span class="nt">&gt;</span>Standard delivery<span class="nt">&lt;/button&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">(</span><span class="na">mut</span> <span class="na">shipmentType</span><span class="err">)</span> <span class="err">&quot;</span><span class="na">urgent</span><span class="err">&quot;}}</span><span class="nt">&gt;</span>48h delivery<span class="nt">&lt;/button&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">onclick=</span><span class="s">{{action</span> <span class="err">(</span><span class="na">mut</span> <span class="na">shipmentType</span><span class="err">)</span> <span class="err">&quot;</span><span class="na">next-day</span><span class="err">&quot;}}</span><span class="nt">&gt;</span>Next day delivery<span class="nt">&lt;/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This, in combination with the <code>value</code> option, can save you the tedium of defining super simple functions
to extract some attribute from the first argument.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;p&gt;</span>The mouse X position is: {{mouseX}}<span class="nt">&lt;/p&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;draw-canvas&quot;</span> <span class="na">onmousemove=</span><span class="s">{{action</span> <span class="err">(</span><span class="na">mut</span> <span class="na">mouseX</span><span class="err">)</span> <span class="na">value=</span><span class="s">&quot;screenX&quot;</span><span class="err">}}</span><span class="nt">&gt;&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember that you can use this not only with events but with any object.</p>

<p>For example, if you want to have an instance of <a href="http://www.ember-power-select.com">Ember Power Select</a> bound to some
<em>queryParam</em>, you can do this:</p>

<figure class='code'><figcaption><span>controller.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">queryParams</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;teacherId&#39;</span><span class="p">]</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>route.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">queryParams</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">teacherId</span><span class="o">:</span> <span class="p">{</span> <span class="nx">refreshModel</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">model</span><span class="p">({</span> <span class="nx">teacherId</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;homework&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">teacherId</span> <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>helpers/find-by.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">&#39;ember&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Helper</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="kd">function</span><span class="p">([</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">attrName</span><span class="p">,</span> <span class="nx">attrValue</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">el</span> <span class="o">=&gt;</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">attrName</span><span class="p">)</span> <span class="o">===</span> <span class="nx">attrValue</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>template.hbs </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;p&gt;</span>Select a teacher to filter homework<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>{{#power-select options=teachers selected=(find-by teachers &#39;id&#39; teacherId) onchange=(action (mut teacherId) value=&quot;id&quot;) as |teacher|}}
</span><span class='line'>  {{teacher.fullName}} - {{teacher.group.name}}
</span><span class='line'>{{/power-select}}
</span></code></pre></td></tr></table></div></figure>


<p>Selecting a teacher will pass that <code>Teacher</code> model to the <code>onchange</code> function. From that teacher
we extract only the <code>id</code> with <code>value="id"</code> which is passed to <code>(mut teacherId)</code> as its first argument.
That updates the <code>teacherId</code> property in the controller, that is bound to a <em>queryParam</em> in the URL,
tehen refreshing the model hook of the route.</p>

<p>Neat.</p>

<h2>Summary</h2>

<p>Going forward the Ember 2.0 path, closure actions are one of the tools in your belt you&rsquo;re going to
use more often.</p>

<p>Understanding them fully will allow you to squeeze them to your advantage and write simpler and more maintainable
code.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Inject the Current User Using Ember-simple-auth in Ember 2.0]]></title>
    <link href="http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth/"/>
    <updated>2015-06-18T17:59:39+01:00</updated>
    <id>http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth</id>
    <content type="html"><![CDATA[<p>Earlier this week I was updating a project to the latest version of ember (1.13.2)
and ember-data (beta.19.2) when everything broke.
This post is a disection of why it broke, how I blamed an Ember design change decision and the moment
I realized that the &ldquo;workaround&rdquo; I made was actually a much better solution than the one I had before.</p>

<!-- more -->


<p>Let&rsquo;s start with the troublemaker code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// app/initializers/current-user.js</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">&#39;ember&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;current-user&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">after</span><span class="o">:</span> <span class="s1">&#39;simple-auth&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">application</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>    <span class="nx">application</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">application</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">application</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;simple-auth-session:main&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">application</span><span class="p">.</span><span class="nx">deferReadiness</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">run</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">let</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">let</span> <span class="nx">userType</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;user_type&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="nx">userType</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">registry</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;store:main&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">userType</span><span class="p">,</span> <span class="nx">userId</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;userPrivateInfo&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>            <span class="nx">application</span><span class="p">.</span><span class="nx">advanceReadiness</span><span class="p">();</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">session</span><span class="p">.</span><span class="nx">addObserver</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">let</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="kd">let</span> <span class="nx">userType</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;user_type&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="nx">userType</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">registry</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;store:main&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">userType</span><span class="p">,</span> <span class="nx">userId</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="nx">application</span><span class="p">.</span><span class="nx">advanceReadiness</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m not proud if this piece of code, but I took it from a blog post somewhere else that was
explaining how to inject the current user in controller/routes/whatever using ember-simple-auth.
If it worked for the author it should work for me and it did after a couple changes.</p>

<p>In a nutshell, that initializer is executed after <em>ember-simple-auth</em> has prepared the session and
its task is to register a service named <code>current-user</code> (initially null) and inject it everywhere.</p>

<p>The rest of the code is the logic that takes care of updating the injected value service once I got the current user
from my API.</p>

<p>It stopped the application&rsquo;s boot and tried to retrieve the user from the server before resuming
the app. If the user was not logged in the boot process continues but it adds an observer in the session
to fetch and replace the service once the session gets the user id.</p>

<p>I didn&rsquo;t expected to ever lay my eyes on this code again, but life had other plans.</p>

<p>I updated to ember 1.13 successfully, but then I updated ember-data the app suddenly stopped working.</p>

<p>Apart from some deprecation warnings about registering/injecting stuff using the container, the
problem with this initializer was that <code>lookup('store:main')</code> suddenly was undefined. <strong>WAT?</strong></p>

<p>I dug a bit and I discovered that in recent version of ember-data the initialization of the store
was moved from a regular initializer to an instance initializer if you&rsquo;re on a version of ember that
supports them (1.12+). And since instance initializers are executed <em>after</em> regular initializers the
store wasn&rsquo;t available yet.</p>

<blockquote><p>Ok, not a big deal, I&rsquo;ll convert this into an instance initializer.
- An naive developer (Me)</p></blockquote>

<p>The new initializers have a different signature. Instead of receiving the container and the application
they receive an <code>applicationInstance</code> that gives access both to the <em>registry</em> and the <em>container</em>. I
changed the relevant lines to look like this and refreshed the browser</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// app/instance-initializers/current-user.js</span>
</span><span class='line'><span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">appInstance</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">registry</span> <span class="o">=</span> <span class="nx">appInstance</span><span class="p">.</span><span class="nx">registry</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>  <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;simple-auth-session:main&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">deferReadiness</span><span class="p">();</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>appInstance.deferReadiness is not a function
- Mr. Chrome</p></blockquote>

<p>I inspected the object and dove into the deep internet to confirm the bitter truth. You can&rsquo;t defer \
the readiness of the application from an instance initializer.
<strong>Why would whoever did this remove that feature? Most of my app needs access to the current user in order to work!</strong>
And that it&rsquo;s not the only problem. You no longer can inject <code>null</code> as a service.</p>

<blockquote><p>Ok, I inject an empty object later my observer will swap them.</p></blockquote>

<p>Again, nope. Ember now doesn&rsquo;t allow to register something under the same name once the application
has started.</p>

<blockquote><p>Ok, initializers are not useful anymore. Thanks for nothing!</p></blockquote>

<p>I was starting to feel angry. I tried then to create an autonomous service that takes care of all
the login. I can&rsquo;t show you the exact code because I never commited it but looked similar to this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Service</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">PromiseProxyObject</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">store</span><span class="o">:</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">inject</span><span class="p">.</span><span class="nx">service</span><span class="p">(),</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">user_type</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">getProperties</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_type&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">user_id</span> <span class="o">&amp;&amp;</span> <span class="nx">user_type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">user_type</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>My idea was: If my service is a <code>PromiseProxyObject</code> and its content is also another <code>PromiseProxyObject</code>
I should be able to access the user though a double proxied interface.
I thought I had been very clever. It was self contained and clear and it worked! &hellip;.ish.
It only worked if you already had a session, but not if you try to login.</p>

<p>When you&rsquo;re not logged the content of this PromiseProxyObject is undefined. I was planning to set
the content to the current user in my login action and remove it when I log out, but what I didn&rsquo;t
know was that <code>PromiseProxyObject</code>s doesn&rsquo;t support to change content after creation (and makes
sense, since it has to behave like a promise and promises can&rsquo;t change its status once it&rsquo;s settled).</p>

<p>Time to take a break and look at the problem with a different light. I had a tea while cursing
stability without stagnation and went to <a href="https://emberlondon.slack.com">Ember London&rsquo;s slack channel</a> to share my dispair.</p>

<p>I exposed the problem in the general and <a href="https://github.com/nikz">@nikz</a> told me that when he faced the same problem he
ended up creating a service <code>current-user</code> that had an <code>instance</code> property that is populated from
the application route.</p>

<p>That approach was a bit more manual but I was ok with that, the only thing that I didn&rsquo;t like was that
the public api of this approach was something like <code>currentUser.instance.isTeacher</code>. It doesn&rsquo;t feel
natural to have to call <code>.instance</code> and my app already had the assumption than the current user was a user
all over the place.</p>

<p>The inpiration came in that exact moment from combine my previous failed approach with this one.</p>

<p>What if my service is just an <code>Ember.ObjectProxy</code> that proxies an inner user record? That way
the service is aways there, I don&rsquo;t have to swap it when the user logs in. Instead I just set its
content. Ember won&rsquo;t compain and I can continue to use <code>currentUser</code> as if a it was a real user model.</p>

<p>The final code is very short and the public API remained exactly like it wanted.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// app/instance-initializers/current-user.js</span>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;current-user&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">({</span> <span class="nx">registry</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">      IMPORTANT. This part of the snipped is outdated. Check the last snipped in the bottom</span>
</span><span class='line'><span class="cm">      of the article for a Ember 2.2+ version.</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ObjectProxy</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">isServiceFactory</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="nx">service</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// app/routes/application.js</span>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">beforeModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_populateCurrentUser</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">sessionAuthenticationSucceeded</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_populateCurrentUser</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">_populateCurrentUser</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">user_type</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;session.secure&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">user_type</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;currentUser&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">user</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>When I started this refactor I was annoyed because of ember&rsquo;s design decision, but looking back on the final
result I find that once more not fighting the frameworks tends to reward you with simpler and better
abstractions.</p>

<p>I find this new approach less magical (no hidden observers), with less metaprogramming (I not longer
have to reopen the Session class) while mantaining the same nice public API I had before.</p>

<p>As a final gift for my efforts on this refactor I discovered a very nice advantage of this approach.</p>

<p>Stopping the application&rsquo;s boot process with <code>deferReadiness()</code> until I have the current user before
continuing did not provide any feedback to the user, just a white screen of death, while with the new
approach the <code>loading.hbs</code> template renders as is does with any other promise returned from
<code>beforeModel/model/afterModel</code> hooks.</p>

<p>Even if the start time is the same, the user has the feedback that the app is working as expected faster.</p>

<p>I hope this helps anyone else using ember-simple-auth/torii to update to ride the stable wave and get
rid of all those deprecation warnings before Ember 2.0 cames out.</p>

<h3>UPDATE Ember 2.2+</h3>

<p>Initializers have changed a bit since this post has been published. Now the instance initializer
should looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// app/instance-initializers/current-user.js</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">&#39;ember&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">appInstance</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ObjectProxy</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">isServiceFactory</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="nx">service</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;serializer&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;current-user&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">initialize</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Optimizing APIs With Ember-data and EmbeddedRecordsMixin]]></title>
    <link href="http://miguelcamba.com/blog/2015/03/15/optimizing-apis-with-ember-data-and-embeddedrecordsmixin/"/>
    <updated>2015-03-15T19:42:08+00:00</updated>
    <id>http://miguelcamba.com/blog/2015/03/15/optimizing-apis-with-ember-data-and-embeddedrecordsmixin</id>
    <content type="html"><![CDATA[<p>A couple days ago I had an <em>&ldquo;aha!&rdquo;</em> moment where I tipped my hat to Ember Data&rsquo;s design and flexibility.
This post also distills some tricks of API design I learned from building APIs that scale to millions
of users and many thousands of requests per minute, and how ember-data is totally aligned with it.</p>

<!-- more -->


<p>I had the great luck of have participated in the creation of a some very successful projects that
made me have some tough moments trying to meet the scalability demands. I am very grateful for that
because those are the projects that really push your limits forward as a developer.</p>

<p>Nowadays creating a service will almost always mean creating a backend API consumed by one or many
frontend applications, web or mobile, so scaling a service is all about scaling its API.</p>

<p>If you foreseen tens of millions of users, you need to design your API carefully, and I learned some
of this things the hard way.</p>

<h3>API scaling is all about caching</h3>

<p>That&rsquo;s the the biggest truth about scaling.</p>

<p>I don&rsquo;t care how much love love you have put in writing that service in Go or how you have optimized
your database, the most slow and bloated language/framework combination with the proper caching in
place will outperform your super-efficient implementation by an order of magnitude.</p>

<p>No matter how fast your app works, it will be slower than a slow app not doing anything at all, so
you must design your API with <em>cacheability</em> in mind.</p>

<h3>API caching is all about homogeneity and slices</h3>

<p>When you design a piece of software you put boundaries around parts of your code that you don&rsquo;t want to pollute
(logically speaking) other parts of your code, and you name that concept encapsulation. Proper encapsulation
is the main selling point of that little thing called OOP.</p>

<p>In APIs you do the same, but when performance is a concern, you must take into account that not only the
elements of your API influence its design. How those elements will be consumed is at least as important
as the elements itself, and expose them in a scalable way must be another requirement.
And polluting can also happen between the private/public boundaries.</p>

<p>Imagine that you are designing a system for a car parts provider. Your system will most likely have
a <code>/parts</code> endpoint. This endpoint is consulted all the time by mechanics to check for compatibility,
characteristics and <strong>sometimes</strong> price, so you add a <code>price</code> entry to your payload.</p>

<p>But not all clients get the same price because some got from you a better deal. You don&rsquo;t want the
others to find out this, so that field is calculated by in request based on the user that made the
request.</p>

<p>Congratulations, you&rsquo;re doomed. No caching for you.</p>

<p>Another common example of this is when an endpoint like <code>/users/123</code> conditionally returns the private
information of that used depending if you are that user or not.</p>

<p>This is an example of pollution as a consecuence of poor encapsulation. Your otherwise static and easy
cacheable API has been poisoned by one single dynamic field, and even worse, one you don&rsquo;t even need most of the time.</p>

<p>There is for me <strong>two golden rules in API design</strong>:</p>

<ul>
<li><p><strong>Make your payloads homogeneous</strong>. Two different users requesting the same resource should get an identical
representation of it.</p></li>
<li><p><strong>Minimize the number of moving parts</strong>. A good API is that one that is mostly static and do not
vary depending on the identity of the consumer. You can call this also objective/subjective. If you
are mixing static &amp; objective fields with variable &amp; subjective ones in the same endpoint, specially if
the variable information is not always required, you will have a bad time. Intead you should consider
<em>slicing</em> your app into two separated static/variable endpoints.</p></li>
</ul>


<h3>The objective/subjective encapsulation pattern.</h3>

<p>The paradigmatic case of this pattern is getting the profile information of a user. Imagine an app where some
information of the users is public (username, avatar, etc&hellip;) and other fields are private (email,
facebook, money in the current account&hellip;).</p>

<p>Your <code>/user</code> endpoint will receive millions of requests per day. Searching users, displaying the author
of a publication, and many more, most of them from people that shouldn&rsquo;t know my personal phone number.
Only occasionally you want to display the private information to the user itself and maybe it&rsquo;s close friends.</p>

<p>You can be sure that walk the social graph of a user to determine if I can see the private information
on each request is an absolute performance killer.</p>

<p>I found slicing the <code>user</code> resource into <code>user</code> and <code>user_private_info</code> a pattern that has proven itself
very useful over and over, and I&rsquo;ve enjoyed how ember-data async relations makes implementing this a breeze.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// models/user.js</span>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">username</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">avatar</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">userPrivateInfo</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">belongsTo</span><span class="p">(</span><span class="s1">&#39;user-private-info&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">async</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// models/user-private-info.js</span>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">email</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="nx">money</span><span class="o">:</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The encapsulation rule is simple: If you have any reason to consider some field private, it lives
in the <code>UserPrivateInfo</code> model. Otherwise, it belongs to the <code>User</code> model.
Now you can fetch it in a dedicated endpoint, but since the relationship is asynchronous the private
information will only be fetched when its really necessary.</p>

<p>Any user without permission trying to the the private information will get a <em>403</em>. That shouldn&rsquo;t
occur anyway because your fronted won&rsquo;t try to access the private information if your are not allowed,
but you&rsquo;re safe if that happens.</p>

<p>Taking this approach, the payloads of the different endpoints will look like this:
<code>/api/users/123</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">user</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">id</span><span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;Tomster&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">avatar</span><span class="o">:</span> <span class="s2">&quot;url/to/avatar.jpg&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">user_private_info_id</span><span class="o">:</span> <span class="mi">123</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>/api/user_private_infos/123</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">user_private_info</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">id</span><span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">email</span><span class="o">:</span> <span class="s2">&quot;el_tomster@ember.js&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">money</span><span class="o">:</span> <span class="mi">5000000</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You might have noticed that the <code>id</code> of the user and its private info are the same, so you might think
that I don&rsquo;t really need that field, but that would be leaking an implementation detail into your
business logic. It turns out that I have all the information in the same user table and therefore the ID
is the same, but I could change my mind and store that info in a different table with different ids,
and the same API is still valid.</p>

<p>Also, note that now <code>users</code> API is <em>objective</em>. I don&rsquo;t need to perform an any kind of check to see the
requester and that user are friends. In fact depending on the business logic you might not even need to
be logged to access this resource. This allows to cache this endpoint at a very high level, using Varnish
by example, and don&rsquo;t even touch our servers.</p>

<h3>Pitfalls of this approach: How do I save sliced resources?!?!</h3>

<p>Simple answer is: <strong>You don&rsquo;t</strong></p>

<p>If you have been paying attention you have noticed that this API slicing is more based in the usage of
the API than in the limits of the business logic itself. Conceptually speaking an user has both public
and private information, but it is still only one business object, so the moment will come when
you need to perform a save operation that affects information of both the public and private areas.</p>

<p>It would be massively complicated to synchronize save operations to two endpoints at the same time, so
I take the approach of using <code>user</code> endpoint as single point of entry for write operations on the user
model, and send the private information embedded in the user data.</p>

<p>A <code>PUT</code> request to update the user&rsquo;s profile has this payload:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">user</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">id</span><span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;Tomster&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">avatar</span><span class="o">:</span> <span class="s2">&quot;url/to/new_avatar.jpg&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">user_private_info</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">email</span><span class="o">:</span> <span class="s2">&quot;new_email@ember.js&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">money</span><span class="o">:</span> <span class="mi">5000000</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>create</code> action in the user endpoint will take care of update both the public and private
information, return the user and also sideload the private info with it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">user</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">id</span><span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">username</span><span class="o">:</span> <span class="s2">&quot;Tomster&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">avatar</span><span class="o">:</span> <span class="s2">&quot;url/to/new_avatar.jpg&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">user_private_info_id</span><span class="o">:</span> <span class="mi">123</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nx">user_private_infos</span><span class="o">:</span> <span class="p">[{</span>
</span><span class='line'>    <span class="nx">id</span><span class="o">:</span> <span class="mi">123</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">email</span><span class="o">:</span> <span class="s2">&quot;new_email@ember.js&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">money</span><span class="o">:</span> <span class="mi">5000000</span>
</span><span class='line'>  <span class="p">}]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wrapping up this approach, you have:</p>

<ul>
<li><p>A public <code>/users/:id</code> endpoint highly cacheable, maybe even a candidate to perform HTTP caching.</p></li>
<li><p>A read-only <code>/user_private_info/:id</code> endpoint to get the the private information of the users. This endpoint
happens to encapsulate information that is variable, not usually needed, and would otherwise prevent the previous
endpoint to benefit from caching.</p></li>
<li><p>A write <code>/users/:id</code> endpoint that accepts to receive both public and private info and updated both
in a transactional fashion.</p></li>
</ul>


<h3>Ember Data and DS.EmbeddedRecordsMixin to the rescue</h3>

<p>So we have a <code>User</code> model that when it&rsquo;s loaded from the API received the id of its associated private info,
but when saved carries that record embedded.</p>

<p>I thought I would have to implement some kind of custom serializer myself, but the I discovered that
<code>DS.EmbeddedRecordsMixin</code> accept a very useful configuration object.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// serializers/user.js</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">DS</span> <span class="nx">from</span> <span class="s1">&#39;ember-data&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">DS</span><span class="p">.</span><span class="nx">ActiveModelSerializer</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">DS</span><span class="p">.</span><span class="nx">EmbeddedRecordsMixin</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">attrs</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">userPrivateInfo</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">serialize</span><span class="o">:</span> <span class="s1">&#39;records&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">deserialize</span><span class="o">:</span> <span class="s1">&#39;ids&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all I needed to implement this functionality.</p>

<p>When this record is deserialized coming from the server it will contain the only id but when it&rsquo;s
serialized for being sent to the server the payload will have embedded the user private information,
just like the previous examples. My hands bled of how much I clapped.</p>

<p>I really think that Ember Data and <a href="http://jsonapi.org">json-api</a> are not only useful tools, but also
tools that make you a better programmer, and is amazing how much following it&rsquo;s conventions can help
to get good software design.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to: Tamper Requests With Service Workers]]></title>
    <link href="http://miguelcamba.com/blog/2015/02/15/how-to-tamper-requests-with-service-workers/"/>
    <updated>2015-02-15T14:41:24+00:00</updated>
    <id>http://miguelcamba.com/blog/2015/02/15/how-to-tamper-requests-with-service-workers</id>
    <content type="html"><![CDATA[<p>Service Workers are coming to town. By the time of this writing you can use them in Chrome stable
and in nightly versions of firefox. Not all features are ready, but the most basic ones are, so
you can start using them today.</p>

<p>There isn&rsquo;t still much documentation out there about how to use it, this are my two cents:
How to tamper requests/responses with service workers.</p>

<!--more-->


<h3>Service workers might not work as you think</h3>

<p>I was playing with service workers to add offline capabilities to a pet project of mine (<a href="https://github.com/cibernox/mobile-patterns">mobile-patterns</a>)
and I wanted to return responses from cache when there is no connection available.</p>

<p>It was very easy. The <a href="http://jakearchibald.com/2014/offline-cookbook">offline cookbook</a> that Jake
Archibald put together has lots of good examples.</p>

<p>However, I wanted to let my app know that a response came from the cache instead of from the server.
I am not sure if that is a good practice (time will make us more aware of what is a good idea and what is not),
but I just wanted to do it, so I started inspecting the response and trying several ideas, but none
of it worked as I expected, and that was because I was not understanding how Service Workers and
Requests/Responses are designed.</p>

<h3>Request and responses are not normal objects, they are streams.</h3>

<p>I misundestood this until I read <a href="http://www.w3.org/TR/2015/WD-service-workers-20150205/">the spec</a>
and the <a href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker_API">article in MDN</a>. Well,
to be completely honest I haven&rsquo;t really read the spec cover to cover, but read some parts.</p>

<p>Service Workers is a low level API on purpose, so when we mangle responses we are playing with very
low level objects. It turns out that the responses from the server are streams containinig binary data.</p>

<p>Streams can only be consumed once. That means that if you read the content of a response and then
you forward that response to the browser, the browser will not be able to read it because it has
already been consumed.</p>

<p>Every time you want to mangle a response and the return it, make a clone and mangle the clone instead</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">fetch</span><span class="p">(</span><span class="nx">fetchRequest</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">clonedResponse</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Do your stuff with the clon and return the original response */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h3>In the Service Workers world, promises are everywhere.</h3>

<p>Once you have a service worker in place, all requests that your web performs will pass throught it.
That means that any blocking code in your service worker will kill performance. For that reason, pretty
much everything in the service workers API returns a Promise.</p>

<p><code>caches.match</code> returns a promise that resolves to some cached response. Responses have a <code>blob</code>, <code>text</code> and
<code>json</code> methods, and all of them return a Promise.</p>

<p>You have to go asynchronous.</p>

<h3>The content of a response is a Blob</h3>

<p>Reponses are read-only, so if you want to tamper a response, you need play with the content and return
a new response instead, and the constructor of a response expects a Blob object.</p>

<p>In my example, I was receiving a JSON object and I wanted to add a key to the json. I knew that Blob
existed, but I was not familiar with them.</p>

<p>This is the code that obtains a response from the cache, reads its JSON, adds some information to it
and returns a new response with the modified content but respecting the original headers.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">return</span> <span class="nx">cachedResponse</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">json</span><span class="p">.</span><span class="nx">myCustomField</span> <span class="o">=</span> <span class="s2">&quot;you&#39;ve been rickrolled by a service worker&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">json</span><span class="p">)],</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">blob</span><span class="p">,</span> <span class="p">{</span> <span class="nx">headers</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span> <span class="p">});</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Full example</h3>

<p>You can see a full example with comments <a href="https://github.com/cibernox/mobile-patterns/blob/7d6189a281d39ce558b2db8867fa2e804b75bd41/workers/offline-support.js">here</a>.</p>

<p><strong>Start using Service Workers today!</strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Screencast: Create a Touch Menu Component in Ember.js]]></title>
    <link href="http://miguelcamba.com/blog/2015/01/01/screencast-create-a-touch-menu-component-in-ember-dot-js/"/>
    <updated>2015-01-01T19:56:52+00:00</updated>
    <id>http://miguelcamba.com/blog/2015/01/01/screencast-create-a-touch-menu-component-in-ember-dot-js</id>
    <content type="html"><![CDATA[<p>This post will be short because the content is a screencast (with 2 parts), in which I cover how to create
a a slider menu for mobile web apps, using several components that are animated synchronously.</p>

<!--more-->


<p>I&rsquo;ve been working the last 6 months in The App Bussiness, which as you can imagine is a company fully
dedicated to create mobile apps, for iOS and Android. During this time I&rsquo;ve learnt a bit about the
practices that make a UX a pleasure to use with your fingers. A lot of DOs and DONTs.</p>

<p>There is many curated resources to learn that, but I&rsquo;d say that 99% are focused on native apps, and this
is kind of sad. There is very few mobile web apps that really take advantage of touch gestures, but
there is not technical reason for that.</p>

<p>We can build very nice touch UXs in HTML5, and Ember.js is as good as any other technology to help us
manage the complexity of those interfaces, so I&rsquo;ve made a tutorial of how to create the (probably) most
widespead mobile UX pattern: The touch lateral slider menu:</p>

<p><small>Note: The first part of the screencast is also available in Spanish <a href="https://www.youtube.com/watch?v=hG5-u3toVBE">here</a>, but translate the screencast
seemed too much work, so the second part is only available in English.</small></p>

<p>Part I:</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/QiyuhmbdwnE "></iframe></div>


<p>Part II:</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/aY7EsSWVVTY "></iframe></div>


<p>The code is available here: <a href="https://github.com/cibernox/mobile-patterns">https://github.com/cibernox/mobile-patterns</a>.
I case you want to collaborate, or you have an UX in mind you don&rsquo;t know how to implement using Ember,
don&rsquo;t hesitate and open an issue/PR.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why I Believe That Ember-cli Is a Game-changer]]></title>
    <link href="http://miguelcamba.com/blog/2014/09/28/why-i-believe-that-ember-cli-is-a-game-changer/"/>
    <updated>2014-09-28T23:42:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2014/09/28/why-i-believe-that-ember-cli-is-a-game-changer</id>
    <content type="html"><![CDATA[<p>This post steps a bit out of the ordinary. Usually I write about technical stuff from a neutral
perspective. I write about something I&rsquo;ve done, or learned, but that&rsquo;s all.
This one is highly opinionated. Is all about express a feeling I have.</p>

<p>This post is about why I <em>really</em> think that something big is happening right now in frontend
development that is going to change the way we think about it.</p>

<p><em>That&rsquo;s what I think <a href="http://www.ember-cli.com/">Ember CLI</a> is about to do.</em></p>

<!--more-->


<h3>A few words words about Ember.js</h3>

<p>I&rsquo;ve been using Ember.js a bit more than a year and a half, since some beta version before the
new router saw the light, and I love it.</p>

<p>I won&rsquo;t listing all the reasons because of which I think Ember is great, but I&rsquo;ll mention one
that quite ofter appears in the middle of other people&rsquo;s list and it deserves to be
on top in my opinion.</p>

<p>The best asset that ember provides you is that it <strong>brings uniformity to your code</strong>.</p>

<p>Working in a <a href="https://goldenmanager.com">very big ember app</a> over a year with other 5 or 6
developers makes you realize that this unformity is not a small matter. Follow a set of
conventions on your code is what makes the difference between working next to others and
working <strong>with</strong> other people.</p>

<p>The rules and conventions ember enforces, no matter if you agree with all of them or not, make
your code predictable. Everything has its place, and that is an incredible booster to your team&rsquo;s
productivity. More than once I was in charge of making a change in a part of the code I wasn&rsquo;t
even aware that it existed and I surprised myself being able to find the exact point where I had
to make the change in a matter of minutes.</p>

<p>That is for me the greatest advantage of ember among other options. It doesn&rsquo;t just gives you
the tools to do your job efficiently, it also gives you the guidelines and patterns to organize
logically your logic in a way any other ember developer, even a new one, can understand.</p>

<p>It bring uniformity <em>to the developer</em>.</p>

<h3>A few words about Rails.</h3>

<p>But there is still some missing parts on this.</p>

<p>Frontend development has traditionally been like the wild west. While modularity is a battle
won long time ago in the backend word thanks to frameworks, package managers and patterns to
share and reuse code, modularity is still coming to javascript in ES6. And package managers,
like npm and bower are still relatively new and not completely widespread.</p>

<p>Develop an app is much more than add one feature after the other on a text file. You need
structures, build tools, deploy mechanisms, tests, patterns&hellip; The average toolset of a
frontend developer has expanded considerably in the last couple of years, and integrate a library
on your project is not drop in a file and you&rsquo;re done. Not anymore.</p>

<p>That is just the reason why Ruby on Rails was such a disruptive revolution 10 years ago.
It is not because it brought anything absolutely new to the dev world, but because it gave
a place to each piece of your app in a way that all projects shared the same common foundation.</p>

<p>When that happened, suddenly share and reuse libraries, not among some of your own projects
but with projects of people you don&rsquo;t even know, was simplified massively. Gems that extended
rails with al sort of functionalities expanded like mushrooms in autumn. Authentication,
logging, state managers, middlewares&hellip;you name it. All of them working out-of-the-box
with rails, with maybe just a few config lines. Compared with all the time and effort that it
used to require to integrate properly a 3rd party library in your <em>[put-your-favourite-old-technology-here]</em> project,
that made of rails a game-changer in the industry.</p>

<p>Now I believe that ember-cli is about to achieve the same thing.</p>

<h3>A few words about Ember CLI</h3>

<p>I can&rsquo;t avoid thinking about Ember CLI as <em>&ldquo;the missing parts&rdquo;</em> I mentioned earlier.</p>

<p>To the strong opinions that ember has about how you should organize your code logically,
ember-cli adds the rules of how you must organize your code physically, including the
folder structure and naming, along with a powerful and extensible build pipeline based on
broccoli, package managers and a collection of wisely chosen tools and defaults.</p>

<p>In other terms, it brings uniformity <em>to the machine</em>.</p>

<p>It might not seem a big deal on itself, but that uniformity is what really makes a
difference. I just allows libraries authors to know the foundation of the environment where
its code will be plugged into.</p>

<p>If there is a word that summarizes the doors that ember-cli opens that would be <strong>extensibility</strong>.</p>

<p>That predefined structure along with its modular design, the package managers and an internal
API providing extension hooks open the doors to share addons that <em>just work</em> with any app.</p>

<p>Ember CLI stands in the very same point that Rails did a decade ago.</p>

<h3>A few words about addons</h3>

<p>I&rsquo;ll just illustrate a sample situations that prove the great change that this situation enables.</p>

<p>Is is a known fact that web components are a trendy thing. <em>The next big thing</em> according
to many, because they allow you to just reuse among projects isolated bits of UI that solve
common problems.</p>

<p>Imagine that you have to add a datepicker to a web app you&rsquo;re building. I&rsquo;m sure you faced that problem before.</p>

<p>Since you don&rsquo;t want to reinvent the wheel, you surf the web an choose a cool web component
to make your life easier, but it turns out that <em>it&rsquo;s not so easy either</em>. Maybe the component
requires polymer.js. Almost certainly a datepicker will also require moment.js. Some specific versions.
You have to include in your build pipeline the js file. And also the html template. And the base
stylesheet too. All in the right order and after including its dependencies. And probably register
the component/directive to use it from your templates. The documentation is pretty good (hopefully)
and you will succeed, but it requires a lot of setup.</p>

<p>The standar architecture of Ember CLI allows authors that know their libraries better than you
to wire up things automatically. The ember addon only requires you to install it</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>npm install ember-cli-cool-datepicker --save-dev <span class="c"># Downloads the addon</span>
</span><span class='line'>ember generate ember-cli-cool-datepicker         <span class="c"># Fetches dependencies and wire all together.</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>NOTE:  Since version <code>0.1.5</code> of ember-cli, an addon can be installed with only one command.
You can replace this 2 lines by <code>ember install:addon ember-cli-cool-datepicker</code> and it will
install the package from NPM and execute the corresponding generator.</strong></p>

<p>and use it right away</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">{{</span>cool-date-picker <span class="nv">date</span><span class="o">=</span>birthday <span class="nv">format</span><span class="o">=</span><span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="o">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And possibilities go far beyond this example.</p>

<p>Addons can modify your build process adding pre-processors (p.e. you can start using the new features
of ES6 like classes and generators with <a href="https://github.com/rjackson/ember-cli-esnext">ember-cli-esnext</a>),
register <a href="https://github.com/jamesarosen/ember-cpm">libraries</a>,
change the behaviour of the browser (<a href="https://github.com/rwjblue/ember-cli-content-security-policy">ember-cli-content-security-policy</a>),
deploy automatically your app to S3 using redis as synchronization mechanism (<a href="https://github.com/achambers/ember-cli-deploy">ember-cli-depoy</a>),
add middlewares&hellip;</p>

<p>Imagination is the limit. And the angular <small><em>(badum tsss)</em></small> stone that enables all this possibilities
is <strong>uniformity</strong>.</p>

<p>A couple days ago I published <a href="https://github.com/cibernox/ember-cli-accounting">my first addon</a>
that allows any ember-cli app to use accounting.js with ES6 modules executing just
a command. And creating it was a piece of cake.</p>

<p>That is a truly game-changer for me.</p>

<p>I can&rsquo;t imagine the frontend development following any path other than this. Share and
reuse code like this is the way to go. I don&rsquo;t know how much will take to other competitor projects
to have its own toolset as ember does, but I don&rsquo;t think they can remain on the sidelines
much longer.</p>

<p>New times are coming. Better times I think.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Import Bootstrap Glyphicons in Ember-cli]]></title>
    <link href="http://miguelcamba.com/blog/2014/08/10/import-bootstrap-glyphicons-in-ember-cli/"/>
    <updated>2014-08-10T00:28:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2014/08/10/import-bootstrap-glyphicons-in-ember-cli</id>
    <content type="html"><![CDATA[<p>Lately I&rsquo;ve building a small internal tool using ember-cli. Although it is
intended to be used by the QA team, I like it to be pretty, or at least decent,
so I am using bootstrap to have a good set of base styles.</p>

<p>There is some documentation on the web about how to use bootstrap with ember-cli,
but I&rsquo;ve found it to be outdated in general, since the syntax of the Brocfile.js
of ember-cli&rsquo;s projects has changes a lot in the last months, being now
<code>app.import</code> the swiss knife for almost everything.</p>

<!--more-->


<p>Using bootstrap now is as simple as typing <code>bower install --save bootstrap</code> and
adding this two lines to your brocfile:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s1">&#39;vendor/bootstrap/dist/js/bootstrap.js&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s1">&#39;vendor/bootstrap/dist/css/bootstrap.css&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem appears when you want to use the glyphicons fonts. Bootstraps expects
the fonts to be inside the <code>/fonts</code> folder and nowhere else, so we can&rsquo;t just
import the font like we do with js or css files.</p>

<p>All docs I&rsquo;ve seen about how to do this involve using broccoli plugins and the
old syntax to move files within a tree, but that is not needed anymore.</p>

<p><code>app.import</code> accepts a second argument which is an object to configure its
behaviour, including the output tree where we want a file to be placed.</p>

<p>Add this third sentence under the other two:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s1">&#39;vendor/bootstrap/dist/fonts/glyphicons-halflings-regular.woff&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">destDir</span><span class="o">:</span> <span class="s1">&#39;fonts&#39;</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all. This also works with any other kind of file, like images or
sourcemaps.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[WebP + Ember Components. The Future Is Now]]></title>
    <link href="http://miguelcamba.com/blog/2014/05/07/webp-plus-ember-components-the-future-is-now/"/>
    <updated>2014-05-07T21:09:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2014/05/07/webp-plus-ember-components-the-future-is-now</id>
    <content type="html"><![CDATA[<p>This past weeked I attended to Barcelona&rsquo;s <a href="http://futurejs.org/">Future JS</a> conference. It was an amazing conference and
the level of the talks was outstanding.</p>

<p>The <em>leitmotiv</em> of the whole conference was, as its name suggest, the future of the javascript language
and the web: new APIs, new programming paradigms, web components&hellip; everything that is fashionable in the
web development world.</p>

<p>Today I want to talk about about web components and how they are for me, as concept, the most missed feature
in the web since ever, not only because they are awesome on their own, but because they can push the web
forward in new ways by helping us to support new features in new browsers and degrade gracefully in more crappy
ones.</p>

<!--more-->


<p>I&rsquo;ve been a heavy user of Ember for a year now and I love how Ember&rsquo;s components can bring us the power of
the newest features before thay are implementeda cross all browser, so this demo will leverage
its advantages to conditionally display the best possible image format.</p>

<p>WebP is a new image format created by google (but opensource) that allows images with similar quality but with
much lower weight. Since bandwidth is a valuable resource, specially for mobile devices, I want to use
webp right now, but it turns out that at the time of writting that post, only Chrome and Opera support
this image format. Neither firefox nor safari or IE.</p>

<p>There is a couple ways of acomplish that task on the server side.</p>

<p>One is by detecting in your nginx the images support of the browser by reading a header of the request,
but I serve images from a CDN, so that solution is not for me.</p>

<p>The other one depends on your CDN provider. Some of them support that very same detection: when a
browser requests an image, <code>landscape.jpg</code> by example, they will under the hood serve
to browser with support the webp image enmascarated with the same name.
I don&rsquo;t like this solution either because:</p>

<p>A) It forces you to have a webp version of every non-webp image, which is not always easy or even possible.</p>

<p>B) The worst one: IT LIES. The extension of the image says that is a JPG file but it isn&rsquo;t. If you save the image and
try to open it with you OS image viewer, it will say that the image is damaged. For some uses it might not be
a problem, but it doesn&rsquo;t feels right to me.</p>

<p>With ember components it&rsquo;s very easy to detect the support in the client side, then ask for one format
or another, and also you can out-out of this behavior in a very easy way.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">App</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Application</span><span class="p">.</span><span class="nx">create</span><span class="p">({});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">deferReadiness</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">image</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">App</span><span class="p">.</span><span class="nx">SmartImgComponent</span><span class="p">.</span><span class="nx">reopen</span><span class="p">({</span><span class="nx">webpSupported</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
</span><span class='line'>    <span class="nx">App</span><span class="p">.</span><span class="nx">advanceReadiness</span><span class="p">();</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">image</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">App</span><span class="p">.</span><span class="nx">SmartImgComponent</span><span class="p">.</span><span class="nx">reopen</span><span class="p">({</span><span class="nx">webpSupported</span><span class="o">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">});</span>
</span><span class='line'>    <span class="nx">App</span><span class="p">.</span><span class="nx">advanceReadiness</span><span class="p">();</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">image</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">})();</span>
</span><span class='line'>
</span><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">SmartImgComponent</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Component</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">tagName</span><span class="o">:</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">attributeBindings</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;bestSrc:src&#39;</span><span class="p">],</span>
</span><span class='line'>  <span class="nx">webp</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">bestSrc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">src</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;webpSupported&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;webp&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">){</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">src</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\.(png|jpg|jpeg)$/</span><span class="p">,</span> <span class="s1">&#39;.webp&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">src</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}.</span><span class="nx">property</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it.</p>

<p><code>SmartImgComponent</code> is an ember component that is used like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="nx">smart</span><span class="o">-</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;https://www.gstatic.com/webp/gallery/1.png&quot;</span> <span class="nx">webp</span><span class="o">=</span><span class="kc">false</span><span class="p">}}</span><span class="o">&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{{</span><span class="nx">smart</span><span class="o">-</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;https://www.gstatic.com/webp/gallery/1.png&quot;</span><span class="p">}}</span><span class="o">&lt;</span><span class="err">/td&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It receives the png/jpg version of the image and applying a simple rule, in my case just change the extension,
it outputs an <code>&lt;img&gt;</code> tag with an src to the good url, and you can opt-out to this behaviour using
the <code>webp=false</code> attribute.</p>

<p>The only trick I&rsquo;ve done here has to do with the web support detection. Since is an async test, I need to
pause the start up of the application until I know the support, and then I reopen the component prototype
to add the proper flag and resume the application&rsquo;s start up.</p>

<p>Here is a jsbin showing this in practice: <a href="http://jsbin.com/ucanam/4910/edit">Smart Img Component</a></p>

<p>It&rsquo;s easy for me to imagine more use cases where ember components can be used to detect brower features and
offer a well suited fallback when some browsers doesn&rsquo;t support the native thing yet.</p>

<p>You don&rsquo;t need to wait for the future. Implement it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Benchmarking Ruby 2.1 and Rubinius 2.0]]></title>
    <link href="http://miguelcamba.com/blog/2013/10/05/benchmarking-the-ruby-2-dot-1-and-rubinius-2-dot-0/"/>
    <updated>2013-10-05T20:33:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/10/05/benchmarking-the-ruby-2-dot-1-and-rubinius-2-dot-0</id>
    <content type="html"><![CDATA[<script type="text/javascript">
  (function(){

    var buildTable = function(data){
      var header = data.shift();

      var scoreboard = data[0].map(function(){ return 0; });
      var totalTime = data[0].map(function(){ return 0; });

      html = "";

      html += '<table class="compact benchmark">'
        html += '<thead>'
          html += '<tr>'
            header.forEach(function(e){
              html += '<th>' + e + '</th>'
            });
          html += '</tr>'
        html += '</thead>'
        html += '<tbody>'
          data.forEach(function(row){
            html += '<tr>'
              row.forEach(function(cell, index, array){
                var cellClass = '';

                if (index >= 2){
                  var parsedValue = parseFloat(cell);
                  var valuesArray = array.slice(2, array.length)
                  var parsedArray = valuesArray
                    .map(function(e){ return parseFloat(e) })
                    .filter(function(e){ return !!e; })
                  var allValuesAreCorrect = parsedArray.length == valuesArray.length;

                  cellClass += 'value '

                  if (!parsedValue){
                    cellClass += 'wrong '
                  } else {
                    cell = parsedValue.toFixed(6)
                    if (allValuesAreCorrect){ totalTime[index] += parsedValue }
                    var isMaxValue = Math.max.apply(null, parsedArray) == parsedValue;
                    if (isMaxValue){
                      cellClass += 'slowest '
                    } else {
                      var isMinValue = Math.min.apply(null, parsedArray) == parsedValue;
                      if (isMinValue){
                        cellClass += 'fastest '
                        scoreboard[index] += 1
                      }
                    }
                  }
                }

                html += '<td class="'+cellClass+'">'
                html += cell + '</td>'
                html += '</td>'
              });
            html += '</tr>'
          });
        html += '</tbody>'
        html += '<tfoot>'
          html += '<tr>'
            html += '<td colspan="2"><strong>Victories</strong></td>'
            scoreboard.slice(2,scoreboard.length).forEach(function(e, index, ary){
              var htmlClass = '';
              var isMaxValue = Math.max.apply(null, ary) == e;
              if (isMaxValue){
                htmlClass += 'fastest'
              } else {
                var isMinValue = Math.min.apply(null, ary) == e;
                if (isMinValue){ htmlClass += 'slowest'}
              }
              html += '<td class="'+htmlClass+'">'+e+'</td>'
            });
          html += '</tr>'
          html += '<tr>'
            html += '<td colspan="2"><strong>Total time</strong></td>'
            totalTime.slice(2,totalTime.length).forEach(function(e, index, ary){
              var htmlClass = '';
              var isMaxValue = Math.max.apply(null, ary) == e;
              if (isMaxValue){
                htmlClass += 'slowest'
              } else {
                var isMinValue = Math.min.apply(null, ary) == e;
                if (isMinValue){ htmlClass += 'fastest'}
              }
              html += '<td class="'+htmlClass+'">'+e.toFixed(6)+'</td>'
            });
          html += '</tr>'
        html += '</tfoot>'
      html += '</table>'

      return html;
    }

    $(function(){

      $.get("/javascripts/mri-rubies.json").success(function(json){
        $('#table-ruby-mri-benchmark-placeholder').replaceWith(buildTable(json));
      });


      $.get("/javascripts/all-rubies.json").success(function(json){
        $('#table-ruby-all-benchmark-placeholder').replaceWith(buildTable(json));
      });

      $.get("/javascripts/all-rubies-v2.json").success(function(json){
        $('#table-ruby-all-benchmark-v2-placeholder').replaceWith(buildTable(json));
      });
    })

  })();
</script>


<p>A few days ago a the first preview version of ruby 2.1 was released.</p>

<p>It has many interesting improvements in the language, but the key ones are:</p>

<ul>
<li>Refinements</li>
<li>Decimal Literals</li>
<li>Frozen string literals</li>
<li>Required keyword arguments</li>
<li>Method definition returns Method Name</li>
<li>String#scrub</li>
<li>Named captures in StringScanner</li>
</ul>


<p>Some of this improvements are more exciting than others (thumbs up to frozen string, thumbs down to refinements),
but as Yukuhiro Matsumoto said in his talk at the <a href="http://baruco.org/">Baruco</a>, which I attended, the main changes in this new release are
internal, with the new generational garbage collector as the king of the party.</p>

<!--more-->


<p>I don&rsquo;t want to repeat content on the web, Konstantin Haase already wrote a great article explaining all the new features.
<a href="http://rkh.im/ruby-2.1">Check it out</a> for more detailed information.</p>

<p>It promises better memory handling and lower GC runtime, which its suposed to lead to better overall performance.</p>

<p>I was curious about the numbers but I had not found any updated benchmark out there, so I run the benchmark myself to see it with my own eyes.</p>

<p>For that task, I used the popular <a href="https://github.com/acangiano/ruby-benchmark-suite">ruby-benchmark-suite</a>, which is quite old but has
lots of tests and has become almost a standard.</p>

<p>The benchmark was run in my 2012 macbook air, with a core i7 2.0GHZ (2 physical core, 4 logical cores due to hyperthreading)
and 8GB of ram. It takes about 25 minutes per implementation, just in case you want to run it too.</p>

<p>Just to clarify some details about how I performed the calculation in the bottom of the table, when I sumarize the
victories I just count the victories of each implementation, so raising an exception is a failure, but when measuring the total
time, if any of the implementations failed on that benchmark then its time is not computed in the total time of any implemetation.</p>

<p>These are the results of the three MRI implementations:</p>

<div id="table-ruby-mri-benchmark-placeholder"></div>


<p>From this results we can say that, in general, ruby 2.1 is faster. It is the fastest implementation in
more tests than 1.9 and 2.0 together, even considering that it fails in some benchmarks.</p>

<p>The total time taken by ruby 2.1 is also noticeable lower. Is about a 23% lower than 2.0 and a 27% lower whan 1.9.3.
As I see, the main reason of this huge diference is that some specific tasks, ruby 2.1 is several times faster than
previous implementations, by example in the  <code>micro/bm_gc_array.rb</code> benchmark there is a 500% performance gain.</p>

<p>Probably in real word examples the performance gain will be around 5%, which is anyway a significant improvement.</p>

<p>But it turns out that 2 days ago, while I was writting this post rubinius 2.0 <a href="http://rubini.us/2013/10/04/rubinius-2-0-released/">was released</a>.</p>

<p>Rubinius is by far my favourite alternative ruby implementation and I was excited about that anouncement.
How will rubinius perform against the other implementations? And jruby?</p>

<p>I&rsquo;ve run the same benchmark on <code>rbx-2.0.0</code> working in ruby 2.1 mode and also against <code>jruby 1.7.4</code> running on java 1.7.0_40-b43,
but in this case in ruby 2.0 mode.</p>

<p>All the cutting edge versions avaliable right now.</p>

<div id="table-ruby-all-benchmark-placeholder"></div>


<p>Wow!! I didn&rsquo;t expect that. Rubinius wins in twice as many tests as the second one (ruby 2.1) and also beats jruby
in all the multithreaded tests.</p>

<p>Both, jruby and rubinius outperforms MRI&rsquo;s implementations by an order of magnitude when it comes to parallel processing, that
was expected, but rubinius also doubles the performance on other math tasks.
And jruby also performs very well, and probably would perform better in a computer with more than 2 cores.</p>

<p>Even if ruby 2.1 has the lower total time, this benchmark suite was written 4 years ago. The computer world have changed since then.
Parallel computing is now the present, and I think that both rubinius and jruby have a brilliant future when it comes
to scale our applications to the multi-core world we live now.</p>

<h2>Update</h2>

<p>After some controversy yesterday, I&rsquo;ve repeated the benchmark with some minor changes to make the bechmark more realistic.
As always, is impossible to a syntetic benchmark like this to be trustworthy when it comes to reproduce the real performance that you
will get in your applications.</p>

<p>I&rsquo;ve updated the input size of many benchamarks that runned too fast (in less than a second) to make then more long living. Not in every test, because
sometimes it was not straightforward.
I also set the flag <code>JRUBY_OPTS=-X+C</code> which forces jruby to use the JIT compiler even if the script is very simple.</p>

<div id="table-ruby-all-benchmark-v2-placeholder"></div>


<p>First of all, notice that with the new input sizes some tests that did not fail in the first run failed in some implementations.</p>

<p>With the new benchmark the landscape changed a bit, but no so much. And the alternative implementations shine even more.</p>

<p>Rubinius still is the implementation that wins in more tests, but ruby 2.1 is not longer the second one. Now jruby has the honor.
And also jruby wins an almost all the macro benchmarks, which are the most complex and generic ones.</p>

<p>On the other handle, ruby 2.1 still has the lower total time but jruby is just behind, very close. The diference of time between jruby and
rubinius has increased so the longer tests and the JIT compiler favor jruby more than rbx.</p>

<p>I want to emphasize this because I feel that the more complex and long-living the applications are, the more advantage will the alternative
implementations take from that situation.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Quick Tip: Show Surrounding Lines With Grep]]></title>
    <link href="http://miguelcamba.com/blog/2013/09/16/quick-tip-show-surrounding-lines-with-grep/"/>
    <updated>2013-09-16T22:23:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/09/16/quick-tip-show-surrounding-lines-with-grep</id>
    <content type="html"><![CDATA[<p>A few days ago I made one of these small discoveries that make you smile and at the same time cry for all the time you have lost.
And one more time I got a reminder that mastering unix tools can make your life easier. God save the <code>man</code> command.</p>

<!--more-->


<p>I was trying to debug an error in production. An ajax call was failing randomly (aparently) with a 500 but I couldn&rsquo;t figure out how to reproduce it,
so my plan was to navigate around the page until I can understand what kind of parameters make the ajax call fail.</p>

<p>The fastest way to see that is look at the log.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tail -f logs/production.log</span></code></pre></td></tr></table></div></figure>


<p>Fail!</p>

<p>The aplication has a pooling service that pollutes the log with a lot of requests that doesn&rsquo;t matter to me and makes impossible to find anything.</p>

<p>So I piped the output of the tail command to grep</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tail -f logs/production.log | grep "500 Internal Server Error"</span></code></pre></td></tr></table></div></figure>


<p>Fail again. I see all the errors but I don&rsquo;t see the the context, so I can&rsquo;t know which action failed or what parameters made the request fail.</p>

<p>But unix always surprises me.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NAME
</span><span class='line'>       grep, egrep, fgrep - print lines matching a pattern
</span><span class='line'>
</span><span class='line'>SYNOPSIS
</span><span class='line'>       grep [options] PATTERN [FILE...]
</span><span class='line'>       grep [options] [-e PATTERN | -f FILE] [FILE...]
</span><span class='line'>
</span><span class='line'>DESCRIPTION
</span><span class='line'>       Grep searches the named input FILEs (or standard input if no files are named, or the file name - is given) for lines containing a match to the given PAT-
</span><span class='line'>       TERN.  By default, grep prints the matching lines.
</span><span class='line'>
</span><span class='line'>       In addition, two variant programs egrep and fgrep are available.  Egrep is the same as grep -E.  Fgrep is the same as grep -F.
</span><span class='line'>
</span><span class='line'>OPTIONS
</span><span class='line'>       -A NUM, --after-context=NUM
</span><span class='line'>              Print NUM lines of trailing context after matching lines.  Places a line containing -- between contiguous groups of matches.
</span><span class='line'>
</span><span class='line'>       -a, --text
</span><span class='line'>              Process a binary file as if it were text; this is equivalent to the --binary-files=text option.
</span><span class='line'>
</span><span class='line'>       -B NUM, --before-context=NUM
</span><span class='line'>              Print NUM lines of leading context before matching lines.  Places a line containing -- between contiguous groups of matches.
</span><span class='line'>
</span><span class='line'>       -C NUM, --context=NUM
</span><span class='line'>              Print NUM lines of output context.  Places a line containing -- between contiguous groups of matches.</span></code></pre></td></tr></table></div></figure>


<p>There is many more options, but the important options here are <code>-A</code>, <code>-B</code> and <code>-C</code>. With this options you can show the context around the matchings.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tail -f logs/production.log | grep "500 Internal Server Error" -B 2 -A 5</span></code></pre></td></tr></table></div></figure>


<p>That command shows 2 lines before and 5 after the matching.</p>

<p>It worked like a charm!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SASS Placeholders Versus Mixins and Extends]]></title>
    <link href="http://miguelcamba.com/blog/2013/07/11/sass-placeholders-versus-mixins-and-extends/"/>
    <updated>2013-07-11T21:32:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/07/11/sass-placeholders-versus-mixins-and-extends</id>
    <content type="html"><![CDATA[<p>Sass preprocessors have reached critical mass to consider them a mainstream technology.
Nowadays almost nobody that does some serius frontend still uses plain old css, but some people
that uses <a href="http://sass-lang.com/">sass</a> (or <a href="http://lesscss.org/">less</a>) are using
it like if it where just regular css with nesting and some sintax sugar, without squeezing
all the power that those technologies put in our hands.</p>

<p>This a summary of the main 3 features o SASS, pointing out its differences.</p>

<!--more-->


<h2>@mixin</h2>

<p>Mixins are the most known feature of sass. They allow us to create a sort of <em>functions</em> to
share <strong>similar</strong> styles among our selectors (well, sass also has <strong>functions</strong>, but I can&rsquo;t find a better word).
The most evident use case is the mixins that apply vendor prefixes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="k">@mixin</span><span class="nf"> border-radius</span><span class="p">(</span><span class="nv">$radius</span><span class="p">){</span>
</span><span class='line'>  <span class="na">border-radius</span><span class="o">:</span> <span class="nv">$radius</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-o-border-radius</span><span class="o">:</span> <span class="nv">$radius</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-ms-border-radius</span><span class="o">:</span> <span class="nv">$radius</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-moz-border-radius</span><span class="o">:</span> <span class="nv">$radius</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-webkit-border-radius</span><span class="o">:</span> <span class="nv">$radius</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nt">button</span><span class="p">{</span>
</span><span class='line'>  <span class="k">@include</span><span class="nd"> border-radius</span><span class="p">(</span><span class="mi">10</span><span class="kt">px</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Mixins are the first feature that a sass beginner learns, but is surprising how often I see
them used the wrong way.</p>

<p>By example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="k">@mixin</span><span class="nf"> rounded</span><span class="p">{</span>
</span><span class='line'>  <span class="na">border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-o-border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-ms-border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-moz-border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-webkit-border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nt">button</span><span class="p">{</span>
</span><span class='line'>  <span class="k">@include</span><span class="nd"> rounded</span><span class="p">;</span>
</span><span class='line'>  <span class="na">background</span><span class="o">:</span> <span class="mh">#ccc</span><span class="p">;</span>
</span><span class='line'>  <span class="na">color</span><span class="o">:</span> <span class="mh">#222</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Several lines down, in the same file, or even in another different file</span>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'><span class="nc">.simple-form</span> <span class="nt">input</span><span class="p">{</span>
</span><span class='line'>  <span class="k">@include</span><span class="nd"> rounded</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.main-nav</span> <span class="nc">.item</span><span class="p">{</span>
</span><span class='line'>  <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'>  <span class="nt">a</span><span class="nd">:hover</span><span class="o">,</span> <span class="nt">a</span><span class="nd">:active</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">@include</span><span class="nd"> rounded</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Whats wrong with that?</strong> It&rsquo;s not <strong>DRY</strong>.</p>

<p>This is the generated output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">button</span><span class="p">{</span>
</span><span class='line'>  <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">o</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="m">#ccc</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="m">#222</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.simple-form</span> <span class="nt">input</span><span class="p">{</span>
</span><span class='line'>  <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">o</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.main-nav</span> <span class="nc">.item</span><span class="p">{</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.main-nav</span> <span class="nc">.item</span>  <span class="nt">a</span><span class="nd">:hover</span><span class="o">,</span> <span class="nc">.main-nav</span> <span class="nc">.item</span> <span class="nt">a</span><span class="nd">:active</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">o</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see the <em><strong>exact same 6 lines</strong></em> repeated <em><strong>over and over</strong></em> in our css.</p>

<p>The golden rule of where a mixin is a good choice is just a few line above:</p>

<blockquote><p>They allow us to [&#8230;] share similar styles among our rules</p></blockquote>


<p>The keyword here is <em>similar</em>.</p>

<p>A mixin is used to reuse rules, not values. In this case
to create rounded borders of different radius, but if your ever find yourself writting a mixin
that don&rsquo;t take arguments, <strong>you are doing it wrong</strong>.</p>

<h2>@extends</h2>

<p>The <code>@extends</code> directive, on the other hand, is the static cousin of <code>@mixin</code>.
It is designed for sharing rules and values between selectors while avoiding repetitions.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="nc">.rounded</span><span class="p">{</span>
</span><span class='line'>  <span class="na">border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-o-border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-ms-border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-moz-border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">-webkit-border-radius</span><span class="o">:</span> <span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nt">button</span><span class="p">{</span>
</span><span class='line'>  <span class="k">@extend</span> <span class="nt">rounded</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Some lines down the road..</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.simple-form</span> <span class="nt">input</span><span class="p">{</span>
</span><span class='line'>  <span class="k">@extend</span> <span class="nc">.rounded</span><span class="o">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.main-nav</span> <span class="nc">.item</span><span class="p">{</span>
</span><span class='line'>  <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'>  <span class="nt">a</span><span class="nd">:hover</span><span class="o">,</span> <span class="nt">a</span><span class="nd">:active</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">@extend</span> <span class="nc">.rounded</span><span class="o">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This time, the generated CSS looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.rounded</span><span class="o">,</span> <span class="nt">button</span><span class="o">,</span> <span class="nc">.simple-form</span> <span class="nt">input</span><span class="o">,</span> <span class="nc">.main-nav</span> <span class="nc">.item</span> <span class="nt">a</span><span class="nd">:hover</span><span class="o">,</span> <span class="nc">.main-nav</span> <span class="nc">.item</span> <span class="nt">a</span><span class="nd">:active</span><span class="p">{</span>
</span><span class='line'>  <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">o</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">ms</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.main-nav</span> <span class="nc">.item</span><span class="p">{</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It has just a fraction of the lines that the mixin approach, which is nice because lighter stylesheets
means faster loading times, specially with slow connections (mobiles), and for the browser
is also much more efficient to parse one single rule applied to several selectors than apply
the same rule once for each selector.</p>

<p>This is awesome because thanks to <code>@extend</code> we can have human-readable sass stylesheets (you know, split stylesheets in
several files, put together rules that apply to the same sections or components of the design, &hellip;) and at the
same time have machine-optimized css (all selectors that extend the same parent are chained in one single rule, no
matter in which file or how conceptually unrelated they are) and at the same time we can keep clean our html because
we don&rsquo;t need to add all over the markup classes like <code>.rounded-border</code> or <code>.highlighted-text</code> that have no
meaning from the point of view of the application&rsquo;s domain.</p>

<p>I know that some people disagree on what html classes are, but I am a big fan of use classes
to represent what that element means (<code>.warning</code>, <code>.user-avatar</code> and <code>.selected-day</code> by example) and not
how they must look (<code>.red-box.bordered</code>, <code>.rounded-corners.</code> and <code>.highlighted-text</code> respectively)</p>

<p>After reading this you might wonder why if <code>@extend</code> are so cool, is not so popular and used as <em>mixins</em>.</p>

<p>That&rsquo;s because <code>@extend</code> can be <strong>dangerous</strong>.</p>

<p>The problem with this directive extending classes or id&rsquo;s, is that when that rules you are extending
appears nested on the application, sass must generate all the posible combinations between the nesting classes and
the rules that includes them.</p>

<p>Example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="nc">.button</span> <span class="p">{</span>
</span><span class='line'>  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
</span><span class='line'>  <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">background</span><span class="o">:</span> <span class="nb">green</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.sidebar</span> <span class="nc">.signup</span> <span class="nc">.button</span> <span class="p">{</span>
</span><span class='line'>  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">22</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.registration</span><span class="o">,</span> <span class="nc">.remember-password</span> <span class="p">{</span>
</span><span class='line'>  <span class="nc">.button</span>  <span class="p">{</span>
</span><span class='line'>    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">33</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.edit-account</span> <span class="nc">.delete-area</span> <span class="nc">.button</span><span class="p">{</span>
</span><span class='line'>  <span class="na">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
</span><span class='line'>  <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.article</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">@extend</span> <span class="nc">.button</span><span class="o">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>generates</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.button</span><span class="o">,</span> <span class="nc">.article</span> <span class="nt">a</span> <span class="p">{</span> <span class="c">/* This is probably what you intended to do */</span>
</span><span class='line'>  <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="nb">green</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c">/* But it also generates this combinational mess */</span>
</span><span class='line'><span class="nc">.sidebar</span> <span class="nc">.signup</span> <span class="nc">.button</span><span class="o">,</span> <span class="nc">.sidebar</span> <span class="nc">.signup</span> <span class="nc">.article</span> <span class="nt">a</span><span class="o">,</span> <span class="nc">.article</span> <span class="nc">.sidebar</span> <span class="nc">.signup</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">margin-top</span><span class="o">:</span> <span class="m">22px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.registration</span> <span class="nc">.button</span><span class="o">,</span> <span class="nc">.registration</span> <span class="nc">.article</span> <span class="nt">a</span><span class="o">,</span> <span class="nc">.article</span> <span class="nc">.registration</span> <span class="nt">a</span><span class="o">,</span> <span class="nc">.remember-password</span> <span class="nc">.button</span><span class="o">,</span> <span class="nc">.remember-password</span> <span class="nc">.article</span> <span class="nt">a</span><span class="o">,</span> <span class="nc">.article</span> <span class="nc">.remember-password</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">33px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.edit-account</span> <span class="nc">.delete-area</span> <span class="nc">.button</span><span class="o">,</span> <span class="nc">.edit-account</span> <span class="nc">.delete-area</span> <span class="nc">.article</span> <span class="nt">a</span><span class="o">,</span> <span class="nc">.article</span> <span class="nc">.edit-account</span> <span class="nc">.delete-area</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>.button</code> is a class that is very likely to be customized depending on its containing form, so if with
just 3 appearances generates this dissaster, with 10 appearances just let your imagination fly.</p>

<p>So the rule of thumb is: <em>&ldquo;Only extend a selector if you are absolutely sure that it is never reused in several places&rdquo;</em>.</p>

<p>But the bad part is that you can&rsquo;t always be sure of this, and even if you are sure that at this moment you satisfy that rule,
in the future, you or one of your coworkers can, inadvertently, screw things up.</p>

<h2>%placeholders</h2>

<p>Placeholders are an killer-feature added in sass 3.2, and they come to fix the mess I described before.</p>

<p>Unlike normal selectors, like <code>.classes</code> or <code>#ids</code>, placeholders won&rsquo;t be never compiled. In other words, this little piece of sass</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="err">%</span><span class="nt">button</span><span class="p">{</span>
</span><span class='line'>  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
</span><span class='line'>  <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">background</span><span class="o">:</span> <span class="nb">green</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nt">a</span><span class="p">{</span> <span class="na">color</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>will generate</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">a</span><span class="p">{</span> <span class="k">color</span><span class="o">:</span> <span class="nb">blue</span><span class="p">;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is no reference to <code>%button</code> because placeholders are just named sets of styles meant to be extended by
other selectors, and don&rsquo;t have existence on its own.</p>

<p>Since they don&rsquo;t have existence on its own, they can&rsquo;t be nested, so you can use <code>@extend %placeholder-name</code> with complete safety.</p>

<p>The previous messy example that used <code>@extend</code> on a class could have been written using placeholders this way:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="nc">.button</span><span class="o">,</span> <span class="err">%</span><span class="nt">button</span> <span class="p">{</span>
</span><span class='line'>  <span class="na">display</span><span class="o">:</span> <span class="no">block</span><span class="p">;</span>
</span><span class='line'>  <span class="na">padding</span><span class="o">:</span> <span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="na">background</span><span class="o">:</span> <span class="nb">green</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.sidebar</span> <span class="nc">.signup</span> <span class="nc">.button</span> <span class="p">{</span>
</span><span class='line'>  <span class="na">margin-top</span><span class="o">:</span> <span class="mi">22</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.registration</span><span class="o">,</span> <span class="nc">.remember-password</span> <span class="p">{</span>
</span><span class='line'>  <span class="nc">.button</span>  <span class="p">{</span>
</span><span class='line'>    <span class="na">margin-bottom</span><span class="o">:</span> <span class="mi">33</span><span class="kt">px</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nc">.edit-account</span> <span class="nc">.delete-area</span> <span class="nc">.button</span><span class="p">{</span>
</span><span class='line'>  <span class="na">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
</span><span class='line'>  <span class="na">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.article</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">@extend</span> <span class="err">%</span><span class="nt">button</span><span class="o">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and you only get the rules you intended to get:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.button</span><span class="o">,</span> <span class="nc">.article</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background</span><span class="o">:</span> <span class="nb">green</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.sidebar</span> <span class="nc">.signup</span> <span class="nc">.button</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">margin-top</span><span class="o">:</span> <span class="m">22px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.registration</span> <span class="nc">.button</span><span class="o">,</span> <span class="nc">.remember-password</span> <span class="nc">.button</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">33px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.edit-account</span> <span class="nc">.delete-area</span> <span class="nc">.button</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Wrapping up</h2>

<p>After reading about the differences between mixins, extending classes and extending placeholders, these
are some of the golden rules that I follow when writing stylesheets:</p>

<ul>
<li>NEVER declare mixins that don&rsquo;t accept params: This are not mixins, the are classes/placeholders</li>
<li>NEVER (or almost never) extend normal selectors. You can get unexpected results if that selector appears nested somewhere else on the stylesheets. Use placeholders instead.</li>
<li>Don&rsquo;t over-nest selectors. With sass is easy to forget about the chain an create infamous selectors with 6-7 chained rules.</li>
<li>Don&rsquo;t use tag names in selectors if you can avoid it. That not a taxative rule, but the are less efficient that classes or ids.</li>
<li>Don&rsquo;t use inheritance operator(&ldquo;>&rdquo;). It is VERY unefficient.</li>
<li>Don&rsquo;t use the sibling selector(&ldquo;+&rdquo;). It is VERY unefficient AND is tightly coupled to your current markup. Some javascript libraries,
like Ember.js by example, can insert invisible elements and break that kind of rules.</li>
<li>Don&rsquo;t trust blindly on what you think that sass is generating. Check the generated css from time to time. You can discover mistakes than are unnoted in sass.</li>
<li>Create a colour pallete using variables from the beginning. If you don&rsquo;t do so, you can easily end with 18 different tones
of gray thar are only used in one or two places.</li>
<li>Refactor. While most people cares about its backend/frontend code, the percentage of people that just open existing stylesheets and adds some new rules to
style that new widget he created without trying to reuse existing styles is much higher.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rubytapas.com Downloader. How to Download Files From Https With Authentication]]></title>
    <link href="http://miguelcamba.com/blog/2013/05/04/rubytapas-dot-com-downloader-how-to-download-files-from-https-with-authentication/"/>
    <updated>2013-05-04T02:14:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/05/04/rubytapas-dot-com-downloader-how-to-download-files-from-https-with-authentication</id>
    <content type="html"><![CDATA[<p>A few days ago I susbcribed to <a href="http://www.rubytapas.com/">Rubytapas</a>, a series of short screencasts about ruby
by <a href="http://devblog.avdi.org/">Advi Grimm</a>.</p>

<p>First of all, I have to recommend you to give it a try. A constant source of small pills filled with ruby wisdom.
I&rsquo;ve discovered many usefull tricks. It totally worths the 9$/month.</p>

<h3>The problem</h3>

<p>After my subscription, I wanted to download the old episodes (a few days ago Avdi published the 100th episode)
but I didn&rsquo;t want to do it manually. I googled for a script but I didn&rsquo;t found any, so I decided to write one.</p>

<!--more-->


<p>The problem I found was to download files from an <strong>HTTPS</strong> source that was behind a login form. My first
idea was to use a pure ruby solution like the <code>HTTParty</code> gem, but after a few failed attemps I realized that
<code>curl</code> already has all that I need.</p>

<h3>The idea</h3>

<p>I&rsquo;ve used curl with https a few times, but always with public documents, not with files that was behind an authentication
form, but curl has built-in support for cookies.</p>

<p>To save a cookie you pass the <strong>-c</strong> option for specify the file where to save the cookie, and the <strong>-d</strong>
option for pass a query string with the authentication params.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -c file_name_of_the_cookie.txt -d "username=example@mail.com&password=myPassword123" http://rubytapas.dpdcart.com/subscriber/login?__dpd_cart=8f511233-b72b-4a8c-8c37-fadc74fbc3a1</span></code></pre></td></tr></table></div></figure>


<p>After that, you&rsquo;ll have the cookie saved in a file. Loading that cookie with the <strong>-b</strong> option you can
download files behind the authetication process.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -o episode.mp4 -b cookie-file.txt -d "username=my-email@example.com&password=myPassword123" https://rubytapas.dpdcart.com/subscriber/download?file_id=446</span></code></pre></td></tr></table></div></figure>


<p>It works! It&rsquo;s time to write the script.</p>

<h3>The solution</h3>

<p>First of all we need to know how many episodes have been published and the files we want to download for each one.
If only there was a place from where to obtain the basic information that is published in a compact and organized way!
Oh, there is one. The RSS!</p>

<p>The rss can be easily obtained with a get request. It requires basic authentication, but doesn&rsquo;t need to
set a cookie since there is no need to keep alive any session, so use your favorite http client. Mine is HTTParty,
<em>mainly because of its cool name</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rss</span> <span class="o">=</span> <span class="no">HTTParty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://rubytapas.dpdcart.com/feed&quot;</span><span class="p">,</span> <span class="ss">basic_auth</span><span class="p">:</span> <span class="p">{</span> <span class="ss">username</span><span class="p">:</span> <span class="s2">&quot;my@email.com&quot;</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s2">&quot;myPassword123&quot;</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>The rss file is an XML file that can be parsed and inspected with <a href="http://nokogiri.org/">nokogiri</a>.
Each episode in the rss looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;item&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span><span class="cp">&lt;![CDATA[092 Coincidental Duplication Redux]]&gt;</span><span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link&gt;</span>https://rubytapas.dpdcart.com/subscriber/post?id=185<span class="nt">&lt;/link&gt;</span>
</span><span class='line'>  <span class="nt">&lt;description&gt;</span><span class="cp">&lt;![CDATA[&lt;div class=&quot;blog-entry&quot;&gt;</span>
</span><span class='line'><span class="cp">      &lt;div class=&quot;blog-content&quot;&gt;&lt;p&gt;Katrina Owen contributed an example of coincidental duplication I liked so much I decided to make a second episode about it. Enjoy!&lt;/p&gt;</span>
</span><span class='line'><span class="cp">      &lt;/div&gt;</span>
</span><span class='line'><span class="cp">      &lt;h3&gt;Attached Files&lt;/h3&gt;</span>
</span><span class='line'><span class="cp">      &lt;ul&gt;</span>
</span><span class='line'><span class="cp">      &lt;li&gt;&lt;a href=&quot;https://rubytapas.dpdcart.com/subscriber/download?file_id=445&quot;&gt;092-coincidental-duplication-redux.html&lt;/a&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="cp">      &lt;li&gt;&lt;a href=&quot;https://rubytapas.dpdcart.com/subscriber/download?file_id=446&quot;&gt;092-coincidental-duplication-redux.mp4&lt;/a&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="cp">      &lt;li&gt;&lt;a href=&quot;https://rubytapas.dpdcart.com/subscriber/download?file_id=447&quot;&gt;092-coincidental-duplication-redux.rb&lt;/a&gt;&lt;/li&gt;</span>
</span><span class='line'><span class="cp">      &lt;/ul&gt;&lt;/div&gt;]]&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/description&gt;</span>
</span><span class='line'>  <span class="nt">&lt;guid</span> <span class="na">isPermaLink=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>dpd-5b84a418456992f342a46fe896aa2835b09bd7f4<span class="nt">&lt;/guid&gt;</span>
</span><span class='line'>  <span class="nt">&lt;pubDate&gt;</span>Fri, 03 May 2013 09:00:00 -0400<span class="nt">&lt;/pubDate&gt;</span>
</span><span class='line'>  <span class="nt">&lt;enclosure</span> <span class="na">url=</span><span class="s">&quot;https://rubytapas.dpdcart.com/feed/download/446/092-coincidental-duplication-redux.mp4&quot;</span> <span class="na">length=</span><span class="s">&quot;21645987&quot;</span> <span class="na">type=</span><span class="s">&quot;video/mp4&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;itunes:subtitle&gt;</span>Another example of over-DRYing code<span class="nt">&lt;/itunes:subtitle&gt;</span>
</span><span class='line'>  <span class="nt">&lt;itunes:image</span> <span class="na">href=</span><span class="s">&quot;https://getdpd.com/uploads/ruby-tapas.png&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/item&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each <code>&lt;item&gt;&lt;/item&gt;</code> is an episode. Its title is inside a <code>&lt;title&gt;&lt;/title&gt;</code> and the <code>&lt;description&gt;&lt;/desctiption&gt;</code> contains some html
with one link for each file. The file&rsquo;s url is in the <em>href</em> attribute and the name in the text of the link.</p>

<p>That was all I needed to know. Here is the script.</p>

<figure class='code'><figcaption><span>rubytapas_downloader.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="nb">require</span> <span class="s1">&#39;httparty&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;nokogiri&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">USERNAME</span> <span class="o">=</span> <span class="s2">&quot;email-used@in-registration.com&quot;</span>
</span><span class='line'><span class="no">PASSWORD</span> <span class="o">=</span> <span class="s2">&quot;your-password-here&quot;</span>
</span><span class='line'><span class="no">COOKIE_FILE</span> <span class="o">=</span> <span class="s1">&#39;cookies.txt&#39;</span> <span class="c1"># by example</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">RubytapasDownloader</span>
</span><span class='line'>  <span class="no">FEED_URL</span>  <span class="o">=</span> <span class="s2">&quot;https://rubytapas.dpdcart.com/feed&quot;</span>
</span><span class='line'>  <span class="no">LOGIN_URL</span> <span class="o">=</span> <span class="s2">&quot;http://rubytapas.dpdcart.com/subscriber/login?__dpd_cart=8f511233-b72b-4a8c-8c37-fadc74fbc3a1&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##</span>
</span><span class='line'>  <span class="c1"># Fetchs and parses the rss feed. Generates the episodes</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="n">rss</span> <span class="o">=</span> <span class="no">HTTParty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">FEED_URL</span><span class="p">,</span> <span class="ss">basic_auth</span><span class="p">:</span> <span class="p">{</span> <span class="ss">username</span><span class="p">:</span> <span class="no">USERNAME</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="no">PASSWORD</span> <span class="p">})</span>
</span><span class='line'>    <span class="vi">@episodes</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="p">(</span><span class="n">rss</span><span class="p">)</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="no">Episode</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##</span>
</span><span class='line'>  <span class="c1"># Downloads the new episodes with curl.</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">launch</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;--- LAUNCHING RUBYTAPAS DOWNLOADER ---&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;--- LOG IN AND SAVE COOKIE ---&quot;</span>
</span><span class='line'>    <span class="n">login_and_save_cookie</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">new_episodes</span> <span class="o">=</span> <span class="vi">@episodes</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:downloaded?</span><span class="p">)</span>
</span><span class='line'>    <span class="n">count</span> <span class="o">=</span> <span class="n">new_episodes</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> NEW EPISODES&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">new_episodes</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">episode</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;DOWNLOADING </span><span class="si">#{</span><span class="n">episode</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> (</span><span class="si">#{</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> of </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span class='line'>      <span class="n">episode</span><span class="o">.</span><span class="n">download!</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;--- FINISHED RUBYTAPAS DOWNLOADER ---&quot;</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;--- EXCEPTION RAISED WHILE DOWNLOADING --&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">e</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'>  <span class="k">ensure</span>
</span><span class='line'>    <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="no">COOKIE_FILE</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="no">COOKIE_FILE</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">login_and_save_cookie</span>
</span><span class='line'>    <span class="nb">system</span> <span class="sx">%Q{curl -c </span><span class="si">#{</span><span class="no">COOKIE_FILE</span><span class="si">}</span><span class="sx"> -d &quot;username=</span><span class="si">#{</span><span class="no">USERNAME</span><span class="si">}</span><span class="sx">&amp;password=</span><span class="si">#{</span><span class="no">PASSWORD</span><span class="si">}</span><span class="sx">&quot; </span><span class="si">#{</span><span class="no">LOGIN_URL</span><span class="si">}</span><span class="sx">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Episode</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:files</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##</span>
</span><span class='line'>  <span class="c1"># Extracts informations from the parsed XML node</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">parsed_rss_item</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@title</span> <span class="o">=</span> <span class="n">parsed_rss_item</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\s|\W/</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@files</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="n">parsed_description</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">XML</span><span class="p">(</span><span class="n">parsed_rss_item</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span><span class='line'>    <span class="n">parsed_description</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">link</span><span class="o">|</span>
</span><span class='line'>      <span class="vi">@files</span><span class="o">[</span><span class="n">link</span><span class="o">.</span><span class="n">text</span><span class="o">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">[</span><span class="ss">:href</span><span class="o">]</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##</span>
</span><span class='line'>  <span class="c1"># Simplest approach: If there is a folder named like the episode, it is already downloaded</span>
</span><span class='line'>  <span class="c1"># TODO: Per-file checking instead of just a folder checking</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">downloaded?</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">download!</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
</span><span class='line'>    <span class="n">files</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="p">,</span> <span class="n">url</span><span class="o">|</span>
</span><span class='line'>      <span class="n">file_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">system</span> <span class="sx">%Q{curl -o </span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="sx"> -b </span><span class="si">#{</span><span class="no">COOKIE_FILE</span><span class="si">}</span><span class="sx"> -d &quot;username=</span><span class="si">#{</span><span class="no">USERNAME</span><span class="si">}</span><span class="sx">&amp;password=</span><span class="si">#{</span><span class="no">PASSWORD</span><span class="si">}</span><span class="sx">&quot; </span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="sx">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">RubytapasDownloader</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">launch</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can find the code up to date in my github: <a href="https://github.com/cibernox/rubytapas_downloader">https://github.com/cibernox/rubytapas_downloader</a></p>

<p>Happy hacking! ;)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tutorial: Build a Web App Using Elixir and Dynamo With Streaming and Concurrency]]></title>
    <link href="http://miguelcamba.com/blog/2013/04/29/tutorial-build-a-web-app-using-elixir-and-dynamo-with-streaming-and-concurrency/"/>
    <updated>2013-04-29T03:38:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/04/29/tutorial-build-a-web-app-using-elixir-and-dynamo-with-streaming-and-concurrency</id>
    <content type="html"><![CDATA[<p>Althoug I am mostly a Ruby developer, I like to play with unusual (to me) things from time to time, and
concurrent programming is one of them. Functional programming is great for that, and elixir puts all the power
of the Erlang VM in your hands without renounce to a nice and expresive syntax.</p>

<!--more-->


<p>Is well known that Ruby is not a good language to build concurrent code. MRI, the main ruby interpreter,
has a global lock that prevents any code to run in parallel. It is true that other implementations like JRuby
and Rubinius don&rsquo;t have that global lock, but still there are not optimal for concurrency, because the
language itself is not designed for it:</p>

<ul>
<li><p>Ruby objects are mutable, so it has state. When the code is running in parallel, this may lead to strange
behaviour and bugs due to unespected race conditions unless you are very carefull. And if you are too.</p></li>
<li><p>The basic data-types (arrays, strings, hashes) are not prepared for parallel read/write. To solve this problem
there is a gem called <a href="https://github.com/harukizaemon/hamster">hamster</a> that provides a set of real
inmutable structures, but still, is not part of the core.</p></li>
<li><p>The bast mayority of the libraries are not still thread safe.</p></li>
</ul>


<p>In summary, people that are serious about concurrency tends to use real state-less programming languages.
Functional programming shines with all its bright at this, and one of the most popular programming languages
is <strong>Erlang</strong>.</p>

<h2>Erlang</h2>

<p>Erlang was created in Ericsson in the late eigties and became opensource in the late nineties. Since then
has grown in popularity for make easier to build fault-tolerant real-time applications. Is untyped, has garbage
collection and works with message passing between processes. Today is more than a language, and has a
virtual machine and a standar library focused in concurrency.</p>

<p>It powers some of the most scalable systems in the world. Probably the best example is Whatsapp, with millions
and millions of messages by minute. You should see <a href="http://www.erlang-factory.com/conference/SFBay2012/speakers/RickReed">this talk</a> of
Rick Reed if you are curious about how they acomplished this magic.</p>

<p>For me the problem with Erlang is Erlang itself. I don&rsquo;t like it.</p>

<h2>Elixir</h2>

<p>When I say that I don&rsquo;t like Erlang I mean that I don&rsquo;t like its syntax. Compared with the expresiviness of
Ruby, Erlang is quite mathematical. This is not unexpected, all functional languages are. But since Erlang
is also a runtime environment that executes bytecode, some other languages were build on top of this virtual
machine on the same way that <strong>groovy</strong> or <strong>scala</strong> run on the java virtual machine.</p>

<p>Jose Valim, a ruby hero and well known programmer (<a href="https://github.com/plataformatec/simple_form">simple_form</a>,
<a href="https://github.com/plataformatec/devise">Devise</a>&hellip;) created <a href="http://elixir-lang.org/"><strong>Elixir</strong></a>,
a language that compiles to erlang bytecode with a cleaner syntax, clearly inspired by its ruby background,
and day by day is gaining popularity because it makes more pleasant to build Erlang applications.
Besides, it can cohexist with pure erlang and you can call any erlang function without any perfomance
penalty.</p>

<h2>Dynamo</h2>

<p>If elixir is ruby, <a href="https://github.com/elixir-lang/dynamo"><strong>dynamo</strong></a> is rails. Actually, it is more
similar to sinatra than to rails, but the important thing is that it holds the role of <em>official</em> web
framework for the language.</p>

<p>It uses <a href="https://github.com/extend/cowboy">cowboy</a>, a web server written in pure erlang, so it scales
very well with relatively low resources and is concurrent by conception, on the same way that node.js
is naturally evented and make is interesting to build certain kind of services.</p>

<h2>Requeriments</h2>

<p>You need to have erlang installed in your computer in order to install elixir. You can download the
latest erlang environment from <a href="https://www.erlang-solutions.com/downloads/download-erlang-otp">here</a>,
and then proceed to install elixir. I installed it in maxOS with <em>homebrew</em> (<code>brew install elixir</code>).
The <a href="http://elixir-lang.org/getting-started/introduction.html">official guide</a> has this topic covered for all operative systems.</p>

<p>Dynamo requires as well to have installed <a href="https://github.com/basho/rebar">rebar</a> for compile apps.
Now you can clone elixir repository to create your first app.</p>

<h2>Proof of concept: A Storyteller</h2>

<p>Let&rsquo;s build a simple web app. The idea is that I have some fairy tales in <em>.txt</em> files and I want to
create a web service that sends the story to N browsers in chunks, line by line, with one second between them.
I want to have lots of opened connections for a long period of time without bloking new incoming connections
and without make polling from the client side.</p>

<p>To create your first app and get dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Clone repo and enter its folder</span>
</span><span class='line'>git clone git://github.com/elixir-lang/dynamo.git
</span><span class='line'><span class="nb">cd </span>dynamo
</span><span class='line'><span class="c"># Get dependencies and run tests</span>
</span><span class='line'><span class="nv">MIX_ENV</span><span class="o">=</span><span class="nb">test </span>mix <span class="k">do</span> deps.get, <span class="nb">test</span>
</span><span class='line'><span class="c"># Create the project</span>
</span><span class='line'>mix dynamo ~/storyteller
</span><span class='line'><span class="nb">cd</span> ~/storyteller
</span><span class='line'><span class="c"># Install dependencies. Similar to bundler. Nice!</span>
</span><span class='line'>mix deps.get
</span><span class='line'><span class="c"># Start the server. By default in localhost:4000</span>
</span><span class='line'>mix server
</span></code></pre></td></tr></table></div></figure>


<p>You can go to that url to check that everithing is ok till now.</p>

<p>As with sinatra, dynamo has 2 basic components, the routers, under <code>web/routers</code> and the views, under <code>web/templates</code>.
From the controller you tell the connection to render one of the avaliable templates.</p>

<p>This is how the main router may look like in order to render the <code>index.html.eex</code> template in the root path:</p>

<figure class='code'><figcaption><span>web/routers/application_router.ex </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ex'><span class='line'><span class="kd">defmodule</span> <span class="nc">ApplicationRouter</span> <span class="k">do</span>
</span><span class='line'>  <span class="kn">use</span> <span class="nc">Dynamo.Router</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">prepare</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Pick which parts of the request you want to fetch</span>
</span><span class='line'>    <span class="c1"># You can comment the line below if you don&#39;t need</span>
</span><span class='line'>    <span class="c1"># any of them or move them to a forwarded router</span>
</span><span class='line'>    <span class="n">conn</span><span class="p">.</span><span class="n">fetch</span><span class="p">([</span><span class="ss">:cookies</span><span class="p">,</span> <span class="ss">:params</span><span class="p">])</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s2">&quot;/&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">conn</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="ss">:title</span><span class="p">,</span> <span class="s2">&quot;Welcome to Concurrent Story Teller v0.1!&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;index.html&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the template:</p>

<figure class='code'><figcaption><span>web/templates/index.html.eex </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span><span class="err">&lt;</span>%= @title %&gt;<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/static/favicon.ico&quot;</span> <span class="na">rel=</span><span class="s">&quot;icon&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/static/storyteller.css&quot;</span> <span class="na">media=</span><span class="s">&quot;all&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/storyteller.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main-container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;h1&gt;</span><span class="err">&lt;</span>%= @title %&gt;<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>    <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;stories-list&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h2&gt;</span>Please, choose a story<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>      <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;story&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;h3&gt;</span>Red Riding<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/red-riding&quot;</span><span class="nt">&gt;</span>Read it to me!<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/article&gt;</span>
</span><span class='line'>      <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;story&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;h3&gt;</span>Snow white<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/snow-white&quot;</span><span class="nt">&gt;</span>Read it to me!<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/article&gt;</span>
</span><span class='line'>      <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">&quot;story&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;h3&gt;</span>Cinderella<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/cinderella&quot;</span><span class="nt">&gt;</span>Read it to me!<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/article&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/section&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The extension <code>.eex</code> is like the <code>.erb</code> for ruby, and the code is also evaluated with <code>&lt;%= ... %&gt;</code> or <code>&lt;% ... %&gt;</code>.</p>

<p>The static content, like the <em>favicon.ico</em> or the stylesheets/javascript files are served from the <code>/priv/static</code> folder
but in the <code>/static/name-of-my-asset.css</code> route.</p>

<p>I have 3 fairy tales, <strong>Snow white</strong>, <strong>Red riding</strong> and <strong>cinderella</strong> stored in tree <em>.txt</em> files in the root
folder of the application. I want a page for each of this stories available under the  &ldquo;/name-of-the-tale&rdquo; path.</p>

<p>If you have used sinatra or padrino, dynamo handles routing on a very similar way, so you only needs to enroute
that url to a new action</p>

<figure class='code'><figcaption><span>web/routers/application_router.ex </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ex'><span class='line'>  <span class="c1"># ....</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s2">&quot;/:file_name&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">normalized_title</span> <span class="p">=</span> <span class="nc">String</span><span class="p">.</span><span class="n">capitalize</span><span class="p">(</span><span class="nc">String</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="ss">:file_name</span><span class="p">],</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">conn</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">assign</span> <span class="ss">:title</span><span class="p">,</span> <span class="n">normalized_title</span>
</span><span class='line'>    <span class="n">conn</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">assign</span> <span class="ss">:file_name</span><span class="p">,</span> <span class="n">conn</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="ss">:file_name</span><span class="p">]</span>
</span><span class='line'>    <span class="n">render</span> <span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;story.html&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and create the views</p>

<figure class='code'><figcaption><span>web/layouts/story.html.eex </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span><span class="err">&lt;</span>%= @title %&gt;<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/static/favicon.ico&quot;</span> <span class="na">rel=</span><span class="s">&quot;icon&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;/static/storyteller.css&quot;</span> <span class="na">media=</span><span class="s">&quot;all&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/static/storyteller.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;main-container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;h2&gt;</span><span class="err">&lt;</span>%= @title %&gt;<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>    <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">&quot;chat&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/section&gt;</span>
</span><span class='line'>    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;play&quot;</span> <span class="na">href=</span><span class="s">&quot;/play/&lt;%= @file_name %&gt;&quot;</span><span class="nt">&gt;</span>Play!<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You have noticed that the variable we assign to the connection with <code>conn = conn.assign :title, normalized_title</code>
are can be accessed in the templates as <code>@title</code>. It also can seem weird that all the time you are
overwritting the same variable <code>conn</code> over and over. This is because in elixir all objects are inmutable.
You can&rsquo;t modify the current connection to assign a variable to it. Instead of this, a new connection object
is returned every time you modify it.</p>

<p>This view can be DRYed using layouts, of course, but is ok for now.
This view has a link to <strong>/play/name-of-the-story</strong>, the action that will send the chunked content.</p>

<figure class='code'><figcaption><span>web/routers/application_router.ex </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ex'><span class='line'>  <span class="c1"># ....</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">get</span> <span class="s2">&quot;/play/:story_name&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">conn</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">resp_content_type</span><span class="p">(</span><span class="s2">&quot;text/event-stream&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">conn</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">send_chunked</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">iterator</span> <span class="p">=</span> <span class="nc">File</span><span class="p">.</span><span class="n">iterator!</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">conn</span><span class="p">.</span><span class="n">params</span><span class="p">[</span><span class="ss">:story_name</span><span class="p">]</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nc">Enum</span><span class="p">.</span><span class="n">each</span> <span class="n">iterator</span><span class="p">,</span> <span class="k">fn</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">-&gt;</span>
</span><span class='line'>      <span class="p">{</span> <span class="ss">:ok</span><span class="p">,</span> <span class="n">conn</span> <span class="p">}</span> <span class="p">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">chunk</span> <span class="s2">&quot;data: </span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">await</span> <span class="n">conn</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">on_wake_up</span><span class="p">(</span><span class="ni">&amp;1</span><span class="p">,</span> <span class="ni">&amp;2</span><span class="p">),</span> <span class="n">on_time_out</span><span class="p">(</span><span class="ni">&amp;1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">conn</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">defp</span> <span class="n">on_wake_up</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Nothing</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">defp</span> <span class="n">on_time_out</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Nothing</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this code I set the response header to <strong>text/event-stream</strong> because we want to use some javascript
in the client side to listen to the new chunks without polling.
The <code>conn.set_chunked(200)</code> returns a new connection prepared to send chunks, with <strong>transfer-encoding: chunked</strong>
and <strong>connection: keep-alive</strong>.
The <code>conn.chunk "message"</code> call sends a chunk the given message and returns a tuple, that can be
<code>{ :ok, conn }</code> or <code>{ :error, failure }</code>. Assigning the tuple to <code>{ :ok, conn }</code> saves the connection and
will raise an error if the first element of the tuple is no <code>:ok</code>, which means that something went wrong.</p>

<p>Now let&rsquo;s test out code. The <strong>curl</strong> command is perfec for this.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -i http://localhost:4000/play/cinderella
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>transfer-encoding: chunked
</span><span class='line'>connection: keep-alive
</span><span class='line'>server: Cowboy
</span><span class='line'>date: Mon, 29 Apr 2013 15:12:27 GMT
</span><span class='line'>content-type: text/event-stream; charset=utf-8
</span><span class='line'>cache-control: max-age=0, private, must-revalidate
</span><span class='line'>
</span><span class='line'>data: Once upon a time... there lived an unhappy young girl.
</span><span class='line'>data: Unhappy she was, for her mother was dead, her father
</span><span class='line'>data: had married another woman, a widow with two daughters,
</span><span class='line'>data: and her stepmother didn't like her one little bit. All
</span><span class='line'>data: the nice things, kind thoughts and loving touches were
</span><span class='line'>data: for her own daughters. And not just the kind thoughts
</span><span class='line'># ...</span></code></pre></td></tr></table></div></figure>


<p>Aparently it works! Now lets do some javascript.</p>

<figure class='code'><figcaption><span>/priv/static/storyteller.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.play&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventSource</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">href</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">$line</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;p class=&quot;story-line&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="s1">&#39;&lt;/p&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">$line</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">&#39;#chat&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">().</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;html, body&quot;</span><span class="p">).</span><span class="nx">animate</span><span class="p">({</span> <span class="nx">scrollTop</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="p">},</span> <span class="s2">&quot;slow&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>I catch the click on the &ldquo;Play&rdquo; link and create an event source that receives the chunks from the server.
Each time a chunk is received it is appended in a reserved area with some fancy animations.</p>

<p>Let&rsquo;s test it in the browser:</p>

<div class="embed-video-container"><iframe src="http://www.youtube.com/embed/1lALr-Wulbg "></iframe></div>


<p>Cool, ah?</p>

<p>I encourage you to play with both, elixir and dynamo. Is maybe more suitable for concurrency newbies
(as I am) than stand alone elixir, and allows your to build read things in a snap.</p>

<p>You can find the application in <a href="https://github.com/cibernox/storyteller">my github</a>. Fork it!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Git Tip: Merge Branches Taking Always Changes From One of Them]]></title>
    <link href="http://miguelcamba.com/blog/2013/04/24/git-tip-merge-branches-taking-always-changes-from-one-of-them/"/>
    <updated>2013-04-24T02:56:00+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/04/24/git-tip-merge-branches-taking-always-changes-from-one-of-them</id>
    <content type="html"><![CDATA[<p>This is a trick I discovered a few days ago and made me cry remembering the time I lost fixing manually
conflics when I already knew that the changes I wanted were all from same branch.</p>

<p>Never again using merge strategies.</p>

<!--more-->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git merge [-s recursive] -X[theirs|ours]</span></code></pre></td></tr></table></div></figure>


<p>If you, being in the branch <strong>master</strong>, run <code>git merge -Xtheirs experimental_feature</code> the conflics will
be automatically resolved taking the changes from the <strong>experimental_feature</strong> branch.
The opposite, <code>git merge -Xours experimental_feature</code>, will keep the code from the current branch.</p>

<p>The <code>-s recursive</code> forces the merging strategy to the <em>recursive</em> mode, which is the only strategy that
accepts the <strong>theirs</strong> and <strong>ours</strong> options. I did not know there where different strategies for
merge branches, but there are several. This is the default strategy when pulling or mergin <em>one</em>
branch into another, so most of the time won&rsquo;t have to specify this but is good to know. <em>(did you even
know that you can merge more than two branches at once?)</em></p>

<p>Hope it helps.</p>

<p>Happy merging.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tweak and Improve Your New Octopress Blog]]></title>
    <link href="http://miguelcamba.com/blog/2013/04/22/tweak-and-improve-your-new-octopress-blog/"/>
    <updated>2013-04-22T20:28:23+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/04/22/tweak-and-improve-your-new-octopress-blog</id>
    <content type="html"><![CDATA[<p>After publish your blog, there is still a few things you can do to improve it. These are some of them:</p>

<h3>Point your own domain to GitHub pages</h3>

<p>This is a must have. Have your own domain is cool. If you don&rsquo;t like the <em>.github.io</em> at the end of the address bar,
you can point your domain to github.</p>

<!--more-->


<ul>
<li>Create a file named <code>CNAME</code> in the root of your repository with the nude name of domain. With nude I mean
without <code>www.</code> of <code>http://</code>.
<figure class='code'><figcaption><span>CNAME </span></figcaption></li>
</ul>


<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>miguelcamba.com</span></code></pre></td></tr></table></div>


<p></figure>
* Configure the DNS in your domain control panel. Make the root domain (<em>the @</em>) point to <code>204.232.175.78</code>, which is
  github&rsquo;s IP, and the <em>www</em> subdomain to <code>your-username.github.com</code>. Screenshot from my namecheap configuration.</p>

<p><img class="center" src="http://miguelcamba.com/images/dns_configuration.jpg"></p>

<p>And wait the dns changes to propagate. For me it took less than 15 minutes but can take much longer.</p>

<h3>Add a new page to your blog</h3>

<p>The main part of your blog are the posts but with octopress you can create any page or section that makes sense to you.
Some ideas: Host the documentation/demo of one of your opensource proyects, an about-me section, a portfolio&hellip;</p>

<p>The pages can be places anywhere in the <strong>/source</strong> folder, but there is 2 main aproaches.</p>

<ul>
<li>If you want the url to look like <em>domain.com/about-me</em> you must create a file <strong>/source/about-me/index.markdown</strong>.
You can use the rake task <code>rake new_page[about-me]</code></li>
<li>If you want the url to look like <em>domain.com/about-me.html</em> you must create a file <strong>/source/about-me.markdown</strong>.
You can use the rake task <code>rake new_page[about-me.html]</code></li>
</ul>


<p>Creating this page is more or less like build an static html side with some simple suport for layouts and
partials. The first lines of each page have some comments to configure which layout you want, enable or disable
the footer and more.</p>

<h3>Add google analytics</h3>

<p>Octopress is the essence of a blog generator. It only server static content, so it don&rsquo;t provides you
an admin area to record and see the trafic and see the stats. This is not a big deal since google analytics is
the most powerfull tool you can desire in this area, and octopress has built-in support for it out of the box.</p>

<p>Create a free acount if you don&rsquo;t have one, and add a <em>New account</em> for your blog. During this process you
will get an ID number like <em>AB-12345678-9</em>.</p>

<p>Go and edit your the config file and add this id to the google analytics key.</p>

<figure class='code'><figcaption><span>_config.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="c1"># ---------------------------------- #</span>
</span><span class='line'><span class="c1">#   Google Analytics Configuration   #</span>
</span><span class='line'><span class="c1"># ---------------------------------- #</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">google_analytics_tracking_id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AB-12345678-9</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Done.</strong></p>

<h3>Basic SEO considerations</h3>

<p>First of all, I need to say that I am <strong>NOT</strong> a fan of SEO. In fact, for me is the biggest lie of the modern times, but still
there is a few good practices that you should follow to help google to do its job.</p>

<h5>Keywords &amp; description</h5>

<p>You should add keywords for your blog and for every post you create. This keywords will help google to know
for what searches your content can be a good result, so pick the words wisely. Think about the words you would
type in google to find your own article, but pick just half a docen.</p>

<p>By example, the previous post could have these keywords: <strong>tutorial,create,octopress,2.1,host,github pages,deploy</strong></p>

<p>The description is also important for google, since it&rsquo;s the phase that will show under the link when this blog post
is listed as a search result.</p>

<p>You can these information in the comments section at the beginning of each <em>.markdown</em> file, like the posts.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>layout: post
</span><span class='line'>title: "Tutorial: Create a blog with octopress and host it in github pages"
</span><span class='line'>date: 2013-04-22T21:24:21+02:00
</span><span class='line'>comments: true
</span><span class='line'>categories: [ruby,octopress]
</span><span class='line'>keywords: tutorial,create,octopress,host,github pages,deploy
</span><span class='line'>description: What is octopress and how create and deploy your blog in github pages
</span><span class='line'>---</span></code></pre></td></tr></table></div></figure>


<p>The keywords and the description will be added automatically to the <code>&lt;head&gt;</code> tag.</p>

<p>But there is still a things that can be improved. At the time of writting this, the description was missing
in the posts, and there is no keywords for the blog level. A few lines fixed that problem.</p>

<figure class='code'><figcaption><span>/source/_includes/head.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="c">&lt;!--[if IEMobile 7 ]&gt;&lt;html class=&quot;no-js iem7&quot;&gt;&lt;![endif]--&gt;</span>
</span><span class='line'><span class="c">&lt;!--[if lt IE 9]&gt;&lt;html class=&quot;no-js lte-ie8&quot;&gt;&lt;![endif]--&gt;</span>
</span><span class='line'><span class="c">&lt;!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]&gt;&lt;!--&gt;</span><span class="nt">&lt;html</span> <span class="na">class=</span><span class="s">&quot;no-js&quot;</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span><span class="c">&lt;!--&lt;![endif]--&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>{% if page.title %}{{ page.title }} - {% endif %}{{ site.title }}<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;author&quot;</span> <span class="na">content=</span><span class="s">&quot;{{ site.author }}&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  {% capture description %}{% if page.description %}{{ page.description }}{% elsif site.description %}{{ site.description }}{% endif %}{% endcapture %}
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;{{ description }}&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  {% capture keywords %}{% if page.keywords %}{{ page.keywords }}{% elsif site.keywords %}{{ site.keywords }}{% endif %}{% endcapture %}
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;keywords&quot;</span> <span class="na">content=</span><span class="s">&quot;{{ keywords }}&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The general keywords and description for your blog should be placed in <strong>_config.yml</strong></p>

<h5>Categorize your posts</h5>

<p>Don&rsquo;t forget to add a category (or categories) for each post. Users will be able to find related posts and google
will apreciate also this information.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tutorial: Create a Blog With Octopress and Host It in Github Pages]]></title>
    <link href="http://miguelcamba.com/blog/2013/04/22/tutorial-create-a-blog-with-octopress-and-host-it-in-github-pages/"/>
    <updated>2013-04-22T20:24:21+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/04/22/tutorial-create-a-blog-with-octopress-and-host-it-in-github-pages</id>
    <content type="html"><![CDATA[<p>I&rsquo;ll start talking about the last thing I started to experiment with, that is this very blog you are
reading right now, built with Jekyll + Octopress.</p>

<!--more-->


<h3>Jekyll.</h3>

<p>Straight-forward definition taken directy from the Github&rsquo;s repository description.</p>

<blockquote><p>Jekyll is a blog-aware, static site generator in Ruby</p><footer><strong>https://github.com/mojombo/jekyll</strong></footer></blockquote>


<p>What does that means? The concept of Jekyll is a bit different from the usual blog engine you might
be used to see arround (read: <em>Wordpress</em>).</p>

<p>The tipical blog engine is some kind of web app that integrates administration tools, 3rd party plugins,
WYSIWYG editor, login system, automatic draft saving, flux condenser&hellip; and also serves your static posts.
As you see, most of the features a blog platform provides are not part of a <strong>real</strong> blog&rsquo;s <em>raison d&#8217;etre</em>,
which is to publish content to the world and allow the world to reach that content. Jekyll gets rid of all
these non-esential features. Is just a blog <em>generator</em>.</p>

<p>The keyword here is <strong>generator</strong>. Jekyll don&rsquo;t serves your blog, it only generates the blog as a bunch of static
pages. No content is built at runtime, the html is created at complilation time. This makes the blog
super-simple and blazing fast from the outside. No server processing, your blog is prebuilt.</p>

<p>What we loss in exchange? Well, almost everything else. You don&rsquo;t have an admin area, you don&rsquo;t have
an online editor, but hey! <code>We are programmers</code>.</p>

<ul>
<li>We don&rsquo;t need to save drafts, we have even a better tool called version control systems.</li>
<li>We don&rsquo;t like text processors with lots of buttons and menus, we are used to write plain text, and we do it much faster in Markdown in owr favourite text editor.</li>
<li>We don&rsquo;t need to admin tools. We make changes, commit those changes and push them.</li>
</ul>


<p>Of course, this means that Jekyll is not for everybody. Is built for people that is familiar with the
development process and wants to have full control over the process. Each blog posts is placed in a
markdown file (it can also be textile of just plain HTML if your prefer) following some naming and
directory structure conventions, and then compiled into the final html structure that will be accessible
from the outside.</p>

<p>Writing, styling, compiling and adding javascripts is up to you, and now is where Octopress comes into
the scene.</p>

<h3>Octopress</h3>

<p>Octopress is blogging framework built on top of Jekyll.
It extends Jekyll in several ways, but the main ones are:</p>

<ul>
<li>Support for themes. Easy to install, based on HTML5 semantics, and mobile-friendly.</li>
<li>Provides a complete collection of plugins for common things like comments, share in social networks
and more. Since octopress is very focused into programming world, there is also plugins to embed code
from files in our local system, from gists and even from github&rsquo;s commits, with syntax highlighting
and all the refinements you can desire.</li>
<li>A collection of rake tasks that automates development and deploy.</li>
</ul>


<p>For this tutorial I&rsquo;ll be using the latest code direclty from the master branch and ruby 2.0.</p>

<h3>Instalation</h3>

<p>The fist step is to get octopress, cloning the repo and give it the name you want for your blog.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git://github.com/imathis/octopress.git coder_blog</span></code></pre></td></tr></table></div></figure>


<p>You&rsquo;ll see that octopress has a <code>.rbenv-version</code> file in the root folder that specify ruby 1.9.3-p194 as the desired version.
Maybe you want to update that file to the fresh ruby <code>2.0.0-p0</code> as I did. It&rsquo;s totally compatible. Living on the edge.</p>

<p>Now you can install all dependencies with bundler and run our first rake task to install a theme.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bundle install
</span><span class='line'>rake install</span></code></pre></td></tr></table></div></figure>


<p><code>rake install</code> will install the default theme, but you can install any theme you like cloning the desired
theme into the <code>.themes</code> folder and run the task with the name of the theme. By example, to install the fabric theme:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd octopress
</span><span class='line'>$ git clone git://github.com/panks/fabric.git .themes/fabric
</span><span class='line'>$ rake install['fabric']
</span><span class='line'>$ rake generate</span></code></pre></td></tr></table></div></figure>


<p>You can see a list with some available themes <a href="https://github.com/imathis/octopress/wiki/3rd-Party-Octopress-Themes">here</a> but there is a lot more.</p>

<h3>Configuration</h3>

<p>The next step is to configure the basics of your blog.
Current master branch <em>(octopress 2.0)</em> only has a single configuration file (<code>_config.yml</code>)</p>

<p>Let&rsquo;s fill only the minimum information.</p>

<figure class='code'><figcaption><span>_config.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">fake.coderblog.com</span>
</span><span class='line'><span class="l-Scalar-Plain">title</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Coder blog</span>
</span><span class='line'><span class="l-Scalar-Plain">subtitle</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">For example purposes only</span>
</span><span class='line'><span class="l-Scalar-Plain">author</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Miguel Camba</span>
</span><span class='line'><span class="l-Scalar-Plain">simple_search</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://google.com/search</span>
</span><span class='line'><span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Simple blog built with octopress</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ...</span>
</span><span class='line'><span class="c1"># Lots of configuration parameters.</span>
</span></code></pre></td></tr></table></div></figure>


<h3>The first post</h3>

<p>Now we can create our first post. The naming convention is explained perfectly in the official documentation:
Blog posts must be stored in the <strong>source/_posts</strong> directory and named according to Jekylls naming conventions: <code>YYYY-MM-DD-post-title.markdown</code>.</p>

<p>Instead of generate the file manually, it&rsquo;s much easier to use the built-in rake task <code>rake new_post["Title of the post"]</code>
This task creates a new post with the given title as long as some metadata used by octopress. This is the comments
of this very post.</p>

<figure class='code'><figcaption><span>2013-04-15-tutorial-create-an-octopress-blog-and-host-it-in-github-pages.markdown</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">layout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">post</span>
</span><span class='line'><span class="l-Scalar-Plain">title</span><span class="p-Indicator">:</span> <span class="s">&quot;Tutorial:</span><span class="nv"> </span><span class="s">Create</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">blog</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">octopress</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">it</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">github</span><span class="nv"> </span><span class="s">pages&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">date</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2013-04-22T21:24:21+02:00</span>
</span><span class='line'><span class="l-Scalar-Plain">comments</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'><span class="l-Scalar-Plain">categories</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">ruby</span><span class="p-Indicator">,</span><span class="nv">octopress</span><span class="p-Indicator">]</span>
</span><span class='line'><span class="nn">---</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now, It&rsquo;s your turn. Write somethin interesting. Remember that each time you want to see the preview, you need to regenerate the
blog, but there is another rake task for this too, the <code>rake preview</code> task regenerates the content watching for changes and
starts a small server in port 4000 to serve the blog.</p>

<p>Take a look also to <code>rake generate</code> (generates the content in the <strong>/public</strong> folder manually) and <code>rake watch</code>
(watch for changes into <strong>/source</strong> and <strong>/sass</strong> folders and generates the files automatically)</p>

<h3>Deploy to github pages</h3>

<p>Github pages is an ideal host for this kind of blogs. It&rsquo;s free, fast, reliable and very very geek. In fact nowardays it has
become the most accurate and widespread resume for coders, and so, github pages can be the best way to introduce yourself.</p>

<p>To publish your blog in github pages, the first step is to create a github pages repository. It&rsquo;s really simple,
and you can find the instructions here: <a href="https://help.github.com/articles/creating-pages-with-the-automatic-generator">Creating Pages with the automatic generator</a></p>

<p>Once you have finished this steps, you&rsquo;ll have a repository named as <code>your-username.github.io</code>, almost empty. You want to deploy your first article to
that empty repository, but you before that you should know how github pages work.</p>

<p>Github pages expect to have <em>two branches</em>, the <strong>source</strong> branch and the <strong>master</strong> branch.
The <strong>master</strong> branch is the one that github pages will show. The changes in the <strong>source</strong> branch won&rsquo;t be published
until you push your changes to master. A very simple workflow we use very often while coding, applied to publishing.
You can configure those branchs manually and add your github pages repository as a remote, but there is also a rake
task that does all for you: <code>rake setup_github_pages[repo]</code>.</p>

<p>In the case of this blog, I ran <code>rake setup_github_pages[git@github.com:cibernox/cibernox.github.io.git]</code> and the
<code>rake deploy</code> to upload the blog. In a snap the blog will be accessible in the url **<a href="http://your-username.github.io**.">http://your-username.github.io**.</a></p>

<p>Remember that <code>rake deploy</code> just generates the blog a push to the <strong>master</strong> branch. Your <strong>source</strong> branch won&rsquo;t be
uploaded to github if you don&rsquo;t want to. You probably want, to have a secure backup online, among other reason. Commit your
changes and do <code>git push origin source</code>.</p>

<h5>Advice for deploy</h5>

<p>I&rsquo;ve found a problem running the rake task that setups for github pages. If you have a <strong>CNAME</strong> file to
specify the domain of your blog, the rake task will make some weird assumptions about naming that make the
task fail. So, if you plan to redirect your domain to github pages, add the <strong>CNAME</strong> file after running this task.</p>

<h3>Next steps</h3>

<p>Now your blog is online, so what&rsquo;s next? These are only advices, but you may be interested in perform some of this tasks.</p>

<ul>
<li>Redirect your own domain to github pages. Because is cool to have your own domain.</li>
<li>Add a entire new section. Like an about-me section (hubris is hubris).</li>
<li>Add google analytics to see the visitants of your blog. Since octopress doesn&rsquo;t provide administration
panel, google analytics is the most convenient way to keep an eye on the traffic of your blog.</li>
<li>Basic SEO. I am <strong>NOT</strong> a fan of SEO. In fact, for me is the biggest lie of the modern times. But there is a few good practices
that you should follow to help google to do its job.</li>
</ul>


<p>In the next article I&rsquo;ll be covering those topics. Stay tuned.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[I Am Back]]></title>
    <link href="http://miguelcamba.com/blog/2013/04/22/i-am-back/"/>
    <updated>2013-04-22T20:21:58+01:00</updated>
    <id>http://miguelcamba.com/blog/2013/04/22/i-am-back</id>
    <content type="html"><![CDATA[<p>Hi. This is my new blog.</p>

<p>Some time ago I had another blog called &ldquo;masquerailes&rdquo;, where I wrote half a docen posts about
development, specially about ruby, in Spanish. Lots of things happened, now I live in another city
in the other side of the country and changed my job twice, but at the end my calling remains untouch.</p>

<p>Coding.</p>

<!--more-->


<p>I love coding. I feel very fortunate for have made of my hobby a way of living.
But life has a lot of facets, and even if I love to make experiments and research on coding topics,
I also had lots of things that drawn my attention enough to stop writting my old blog. That are not
bad things, build a family and have other hobbies are always a good thing to have, but I&rsquo;ve realized I miss
to spend more time being creative.</p>

<p>At work most people can&rsquo;t be as creative as they would like, because the <strong>real</strong> work is always there,
waiting to be done, and deadline exist. When you have milestones to reach and deadlines to respect, you
tend to follow the path you know better, even when if you would like to try some new tools or
patterns that could fit better.</p>

<p><em>That&rsquo;s why I write this blog.</em></p>

<p>I want to force myself to push my limits, to exit my confort zone and write about topics I know well
and want to know better (by sharing with the world a small portion of what I gathered from it) and to
make me research on topics I would like to know more. And incidentally, to practice my English.</p>

<p>So my first blog post will be about creating your own blog using Jekyll and Octopress and host it for
free in github pages. This one you are reading right now :)</p>

<p>See you soon.</p>
]]></content>
  </entry>
  
</feed>
