
<!doctype html>
<html lang="pt-br">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  

  

  

  

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=860">

  <meta name="author" content="Miguel Camba" />
  <link rel="publisher" href="https://plus.google.com/+104848632337303003619" />
  <meta property="og:title" content="How to Inject the Current User Using Ember-simple-auth in Ember 2.0 - Coder idiosyncrasy" />
  <meta property="og:site_name" content="Coder idiosyncrasy" />
  <meta property="og:type" content="article" />
  <meta property="og:locale" content="pt-BR" />
  <meta name="description" content="How to Inject the Current User Using Ember-simple-auth in Ember 2.0 Jun 18th, 2015 5:59 pm, ember.js Earlier this week I was updating a project to &hellip;" />
  <meta property="og:description" content="How to Inject the Current User Using Ember-simple-auth in Ember 2.0 Jun 18th, 2015 5:59 pm, ember.js Earlier this week I was updating a project to the latest version of ember (1.13.2)
and ember-data (beta.19.2) when everything broke.
This post is a disection of why it broke, how I blamed an Ember design change decision and the moment
I realized that the &ldquo;workaround&rdquo; I made was &hellip;" />
  <meta property="og:url" content="http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth/" />
  <meta property="og:image" content="http://miguelcamba.com/images/" />

  <meta property="article:author" content="https://www.facebook.com/" />
  <meta property="article:publisher" content="https://www.facebook.com/" />

  
    <meta name="keywords" content="API, ember, ember-data, EmbeddedRecordsMixin" />
  

  <title>How to Inject the Current User Using Ember-simple-auth in Ember 2.0 - Coder idiosyncrasy</title>

  <link rel="canonical" href="http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth">
  <link href="  /favicon.ico" rel="icon">
  <link href="http://fonts.googleapis.com/css?family=Crete+Round:400" rel="stylesheet" type="text/css">
  <link href="  /stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Coder idiosyncrasy" type="application/atom+xml">
</head>

  <body  id="post" >
    <div class="cover-image"></div>

<header id="header" role="banner" class="internal-page">
  <div class="content">
    <h1><a href="  /">Coder idiosyncrasy</a></h1>
    <h1 id="second-link"><a href="/talks">Talks</a></h1>
    <h1 id="third-link"><a href="/about">About</a></h1>
    
  </div>
</header>

    <main role="main">
      <div class="content">
  <article role="article">
    
  <header>
    <h1>
    
      
        How to Inject the Current User Using Ember-simple-auth in Ember 2.0
      
    
    </h1>

    
      





      <span class="meta">
        <time class='entry-date' datetime='2015-06-18T17:59:39+01:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:59 pm</span></time>,
        

  <span class="categories">
    
      <a class='category' href='  /blog/categories/ember-dot-js/'>ember.js</a>
    
  </span>


        


      </span>
    
  </header>



  <p>Earlier this week I was updating a project to the latest version of ember (1.13.2)
and ember-data (beta.19.2) when everything broke.
This post is a disection of why it broke, how I blamed an Ember design change decision and the moment
I realized that the &ldquo;workaround&rdquo; I made was actually a much better solution than the one I had before.</p>

<!-- more -->


<p>Let&rsquo;s start with the troublemaker code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// app/initializers/current-user.js</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">&#39;ember&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;current-user&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">after</span><span class="o">:</span> <span class="s1">&#39;simple-auth&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">application</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>    <span class="nx">application</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">application</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">application</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;simple-auth-session:main&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">application</span><span class="p">.</span><span class="nx">deferReadiness</span><span class="p">();</span>
</span><span class='line'>    <span class="nx">Ember</span><span class="p">.</span><span class="nx">run</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">let</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">let</span> <span class="nx">userType</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;user_type&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="nx">userType</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">registry</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;store:main&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">userType</span><span class="p">,</span> <span class="nx">userId</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;userPrivateInfo&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>            <span class="nx">application</span><span class="p">.</span><span class="nx">advanceReadiness</span><span class="p">();</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">session</span><span class="p">.</span><span class="nx">addObserver</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">let</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="kd">let</span> <span class="nx">userType</span> <span class="o">=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;user_type&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="nx">userType</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">registry</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;store:main&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">userType</span><span class="p">,</span> <span class="nx">userId</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="nx">application</span><span class="p">.</span><span class="nx">advanceReadiness</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m not proud if this piece of code, but I took it from a blog post somewhere else that was
explaining how to inject the current user in controller/routes/whatever using ember-simple-auth.
If it worked for the author it should work for me and it did after a couple changes.</p>

<p>In a nutshell, that initializer is executed after <em>ember-simple-auth</em> has prepared the session and
its task is to register a service named <code>current-user</code> (initially null) and inject it everywhere.</p>

<p>The rest of the code is the logic that takes care of updating the injected value service once I got the current user
from my API.</p>

<p>It stopped the application&rsquo;s boot and tried to retrieve the user from the server before resuming
the app. If the user was not logged in the boot process continues but it adds an observer in the session
to fetch and replace the service once the session gets the user id.</p>

<p>I didn&rsquo;t expected to ever lay my eyes on this code again, but life had other plans.</p>

<p>I updated to ember 1.13 successfully, but then I updated ember-data the app suddenly stopped working.</p>

<p>Apart from some deprecation warnings about registering/injecting stuff using the container, the
problem with this initializer was that <code>lookup('store:main')</code> suddenly was undefined. <strong>WAT?</strong></p>

<p>I dug a bit and I discovered that in recent version of ember-data the initialization of the store
was moved from a regular initializer to an instance initializer if you&rsquo;re on a version of ember that
supports them (1.12+). And since instance initializers are executed <em>after</em> regular initializers the
store wasn&rsquo;t available yet.</p>

<blockquote><p>Ok, not a big deal, I&rsquo;ll convert this into an instance initializer.
- An naive developer (Me)</p></blockquote>

<p>The new initializers have a different signature. Instead of receiving the container and the application
they receive an <code>applicationInstance</code> that gives access both to the <em>registry</em> and the <em>container</em>. I
changed the relevant lines to look like this and refreshed the browser</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// app/instance-initializers/current-user.js</span>
</span><span class='line'><span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">appInstance</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">registry</span> <span class="o">=</span> <span class="nx">appInstance</span><span class="p">.</span><span class="nx">registry</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>  <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">let</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">registry</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="s1">&#39;simple-auth-session:main&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">deferReadiness</span><span class="p">();</span>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>appInstance.deferReadiness is not a function
- Mr. Chrome</p></blockquote>

<p>I inspected the object and dove into the deep internet to confirm the bitter truth. You can&rsquo;t defer \
the readiness of the application from an instance initializer.
<strong>Why would whoever did this remove that feature? Most of my app needs access to the current user in order to work!</strong>
And that it&rsquo;s not the only problem. You no longer can inject <code>null</code> as a service.</p>

<blockquote><p>Ok, I inject an empty object later my observer will swap them.</p></blockquote>

<p>Again, nope. Ember now doesn&rsquo;t allow to register something under the same name once the application
has started.</p>

<blockquote><p>Ok, initializers are not useful anymore. Thanks for nothing!</p></blockquote>

<p>I was starting to feel angry. I tried then to create an autonomous service that takes care of all
the login. I can&rsquo;t show you the exact code because I never commited it but looked similar to this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kr">export</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Service</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Ember</span><span class="p">.</span><span class="nx">PromiseProxyObject</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">store</span><span class="o">:</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">inject</span><span class="p">.</span><span class="nx">service</span><span class="p">(),</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">user_type</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">getProperties</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;user_type&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">user_id</span> <span class="o">&amp;&amp;</span> <span class="nx">user_type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">user_type</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>My idea was: If my service is a <code>PromiseProxyObject</code> and its content is also another <code>PromiseProxyObject</code>
I should be able to access the user though a double proxied interface.
I thought I had been very clever. It was self contained and clear and it worked! &hellip;.ish.
It only worked if you already had a session, but not if you try to login.</p>

<p>When you&rsquo;re not logged the content of this PromiseProxyObject is undefined. I was planning to set
the content to the current user in my login action and remove it when I log out, but what I didn&rsquo;t
know was that <code>PromiseProxyObject</code>s doesn&rsquo;t support to change content after creation (and makes
sense, since it has to behave like a promise and promises can&rsquo;t change its status once it&rsquo;s settled).</p>

<p>Time to take a break and look at the problem with a different light. I had a tea while cursing
stability without stagnation and went to <a href="https://emberlondon.slack.com">Ember London&rsquo;s slack channel</a> to share my dispair.</p>

<p>I exposed the problem in the general and <a href="https://github.com/nikz">@nikz</a> told me that when he faced the same problem he
ended up creating a service <code>current-user</code> that had an <code>instance</code> property that is populated from
the application route.</p>

<p>That approach was a bit more manual but I was ok with that, the only thing that I didn&rsquo;t like was that
the public api of this approach was something like <code>currentUser.instance.isTeacher</code>. It doesn&rsquo;t feel
natural to have to call <code>.instance</code> and my app already had the assumption than the current user was a user
all over the place.</p>

<p>The inpiration came in that exact moment from combine my previous failed approach with this one.</p>

<p>What if my service is just an <code>Ember.ObjectProxy</code> that proxies an inner user record? That way
the service is aways there, I don&rsquo;t have to swap it when the user logs in. Instead I just set its
content. Ember won&rsquo;t compain and I can continue to use <code>currentUser</code> as if a it was a real user model.</p>

<p>The final code is very short and the public API remained exactly like it wanted.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// app/instance-initializers/current-user.js</span>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;current-user&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">({</span> <span class="nx">registry</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">      IMPORTANT. This part of the snipped is outdated. Check the last snipped in the bottom</span>
</span><span class='line'><span class="cm">      of the article for a Ember 2.2+ version.</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ObjectProxy</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">isServiceFactory</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="nx">service</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">registry</span><span class="p">.</span><span class="nx">injection</span><span class="p">(</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// app/routes/application.js</span>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Route</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">beforeModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_populateCurrentUser</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">actions</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">sessionAuthenticationSucceeded</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_populateCurrentUser</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">_populateCurrentUser</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="p">{</span> <span class="nx">user_id</span><span class="p">,</span> <span class="nx">user_type</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;session.secure&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">user_type</span><span class="p">,</span> <span class="nx">user_id</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;currentUser&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">user</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>When I started this refactor I was annoyed because of ember&rsquo;s design decision, but looking back on the final
result I find that once more not fighting the frameworks tends to reward you with simpler and better
abstractions.</p>

<p>I find this new approach less magical (no hidden observers), with less metaprogramming (I not longer
have to reopen the Session class) while mantaining the same nice public API I had before.</p>

<p>As a final gift for my efforts on this refactor I discovered a very nice advantage of this approach.</p>

<p>Stopping the application&rsquo;s boot process with <code>deferReadiness()</code> until I have the current user before
continuing did not provide any feedback to the user, just a white screen of death, while with the new
approach the <code>loading.hbs</code> template renders as is does with any other promise returned from
<code>beforeModel/model/afterModel</code> hooks.</p>

<p>Even if the start time is the same, the user has the feedback that the app is working as expected faster.</p>

<p>I hope this helps anyone else using ember-simple-auth/torii to update to ride the stable wave and get
rid of all those deprecation warnings before Ember 2.0 cames out.</p>

<h3>UPDATE Ember 2.2+</h3>

<p>Initializers have changed a bit since this post has been published. Now the instance initializer
should looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// app/instance-initializers/current-user.js</span>
</span><span class='line'><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">&#39;ember&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="kd">function</span> <span class="nx">initialize</span><span class="p">(</span><span class="nx">appInstance</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">ObjectProxy</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">isServiceFactory</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">&#39;service:current-user&#39;</span><span class="p">,</span> <span class="nx">service</span><span class="p">,</span> <span class="p">{</span> <span class="nx">instantiate</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">singleton</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;route&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">appInstance</span><span class="p">.</span><span class="nx">inject</span><span class="p">(</span><span class="s1">&#39;serializer&#39;</span><span class="p">,</span> <span class="s1">&#39;currentUser&#39;</span><span class="p">,</span> <span class="s1">&#39;service:current-user&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;current-user&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">initialize</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>






    <footer>
      
        <div class="sharing">
  
    <a href="//twitter.com/share" class="twitter-share-button" data-url="http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth/" data-via="miguelcamba" data-counturl="http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth/">Tweet</a>
  

  
    <div class="fb-like" data-href="http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth/" data-layout="button_count" data-action="recommend" data-show-faces="true" data-share="true"></div>
  
</div>

      

      <div class="about-author">
  <img src="http://www.gravatar.com/avatar/aadced6e13c05d42faaf1be3bbb88b83?s=135" width="135" height="135" alt="Miguel Camba" />
  <h3><a href="  /about">Miguel Camba</a></h3>
  
  <div class="author-description">I&#8217;m a web developer from Spain living in London. I do most of my work in Ruby/Rails and Javascript/Ember.js but I like to experiment with bleeding edge technologies. If you need help building your product, I might be able to help you.</div>
  
  <ul class="social-links">
    <li>
      <a href="https://github.com/cibernox" target="_blank">
        <i class="icon-github">GitHub</i>
      </a>
    </li>
    <li>
      <a href="https://www.linkedin.com/in/miguelcamba" target="_blank">
        <i class="icon-linkedin">Facebook</i>
      </a>
    </li>
    <li>
      <a href="https://twitter.com/miguelcamba" target="_blank">
        <i class="icon-twitter">Twitter</i>
      </a>
    </li>
    <li>
      <a href="  /atom.xml" target="_blank">
        <i class="icon-feed">Feed</i>
      </a>
    </li>
  </ul>
</div>


      
        <h4>Also read:</h4>
        <div class="others-posts">
          
            <a class="prev-post" href="  /blog/2015/03/15/optimizing-apis-with-ember-data-and-embeddedrecordsmixin/" title="Post anterior: Optimizing APIs with ember-data and EmbeddedRecordsMixin">
              Optimizing APIs with ember-data and EmbeddedRecordsMixin
            </a>
          
          
            <a class="next-post" href="  /blog/2016/01/24/ember-closure-actions-in-depth/" title="PrÃ³ximo post: Ember closure actions in depth">
              Ember closure actions in depth
            </a>
          
        </div>
      
    </footer>
  </article>
  
  <section class="post-comments">
    <header>
      <h2>Comments:</h2>
    </header>
    
      <div id="disqus_thread"></div>
    
  </section>


</div>

    </main>
    <footer id="footer" role="contentinfo">
  <div class="content">
    <p class="copyright">Copyright &copy; 2017 - Miguel Camba</p>
    <p class="powered-by">Powered by <a href="http://octopress.org">Octopress</a></p>
  </div>
</footer>

    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-40004935-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="  /javascripts/libs/jquery.min.js"><\/script>')</script>
<script src="  /javascripts/application.js"></script>


  
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id; js.async = true;
    js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



  
    <script type="text/javascript">
      var disqus_shortname = 'miguelcamba';
      
        // var disqus_developer = 1;
        var disqus_identifier = 'http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth/';
        var disqus_url = 'http://miguelcamba.com/blog/2015/06/18/how-to-inject-the-current-user-using-ember-simple-auth/';
        var disqus_script = 'embed.js';
      

      (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>
  


  </body>
</html>
